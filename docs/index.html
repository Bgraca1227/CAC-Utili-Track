<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CAC Utili-Track - Professional Utility Mapping</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <style>
        :root {
            /* Light Mode Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-tertiary: #adb5bd;
            
            /* Utility Colors */
            --water-color: #2196F3;
            --gas-color: #FFD600;
            --electric-color: #F44336;
            --sewer-color: #795548;
            --telecom-color: #9C27B0;
            
            /* UI Colors */
            --primary: #1976D2;
            --primary-dark: #0D47A1;
            --primary-light: #42A5F5;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --info: #2196F3;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #757575;
            --primary: #42A5F5;
            --primary-dark: #1976D2;
            --primary-light: #64B5F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Prevent zoom on double tap and pinch */
        body {
            touch-action: pan-x pan-y;
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0D47A1 0%, #1976D2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        }

        .splash-logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 2rem;
        }

        .splash-logo {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .construction-hat {
            width: 120px;
            height: 120px;
            position: relative;
            animation: constructionBounce 2s ease-in-out infinite;
        }

        .construction-hat svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .utility-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: utilityOrbit 8s linear infinite;
        }

        .utility-icon {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            animation: utilityPulse 2s ease-in-out infinite;
        }

        .utility-icon.water {
            background: var(--water-color);
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .utility-icon.gas {
            background: var(--gas-color);
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            color: #333;
        }

        .utility-icon.electric {
            background: var(--electric-color);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .utility-icon.sewer {
            background: var(--sewer-color);
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .utility-icon.telecom {
            background: var(--telecom-color);
            top: 25%;
            left: 25%;
        }

        @keyframes constructionBounce {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes utilityOrbit {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes utilityPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .splash-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .splash-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 3rem;
        }

        .splash-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .splash-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: progressLoad 2.5s ease-out forwards;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* App Container */
        .app-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: var(--bg-secondary);
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: env(safe-area-inset-top, 0);
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 100%);
            z-index: 1000;
            pointer-events: none;
        }

        .top-bar > * {
            pointer-events: auto;
        }

        .mode-indicator {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInDown 0.3s ease-out;
        }

        .mode-indicator i {
            font-size: 16px;
        }

        .mode-indicator.mapping {
            background: var(--primary);
            color: white;
        }

        .mode-indicator.excavation {
            background: var(--warning);
            color: #333;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }

        .top-controls {
            display: flex;
            gap: 8px;
        }

        .control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            transform: translate(-50%, -50%);
            transition: all 0.6s;
        }

        .control-button:active::before {
            width: 100%;
            height: 100%;
        }

        .control-button:active {
            transform: scale(0.95);
        }

        /* Bottom Navigation */
        .bottom-navigation {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 0);
            left: 0;
            right: 0;
            padding: 12px 16px 16px;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 1000;
        }

        .nav-pill {
            background: var(--bg-primary);
            border-radius: 25px;
            padding: 4px;
            box-shadow: var(--shadow-lg);
            display: flex;
            gap: 4px;
            animation: fadeInUp 0.3s ease-out;
        }

        .nav-button {
            position: relative;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 21px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.4);
        }

        .nav-button i {
            font-size: 18px;
        }

        /* Utility Selector */
        .utility-selector {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0) + 80px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border-radius: 30px;
            padding: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            gap: 8px;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .utility-selector.visible {
            opacity: 1;
            visibility: visible;
            animation: fadeInUp 0.3s ease-out;
        }

        .utility-type-button {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .utility-type-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .utility-type-button:active {
            transform: scale(0.9);
        }

        .utility-type-button.active::after {
            opacity: 1;
        }

        .utility-type-button.active {
            box-shadow: 0 0 0 3px var(--bg-primary), 0 0 0 5px currentColor;
        }

        .utility-type-button.water { background: var(--water-color); }
        .utility-type-button.gas { background: var(--gas-color); color: #333; }
        .utility-type-button.electric { background: var(--electric-color); }
        .utility-type-button.sewer { background: var(--sewer-color); }
        .utility-type-button.telecom { background: var(--telecom-color); }

        /* Line Type Selector */
        .line-type-selector {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0) + 140px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 4px;
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 4px;
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .line-type-selector.visible {
            opacity: 1;
            visibility: visible;
            animation: fadeInUp 0.3s ease-out;
        }

        .line-type-button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 16px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .line-type-button.active {
            background: var(--primary);
            color: white;
        }

        /* Floating Action Button */
        .fab {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0) + 90px);
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 997;
        }

        .fab:active {
            transform: scale(0.95);
            box-shadow: var(--shadow-md);
        }

        .fab.confirm {
            background: var(--success);
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 996;
        }

        .map-control {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            font-size: 18px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-control:active {
            transform: scale(0.95);
        }

        /* User Location Marker */
        .user-location-marker {
            width: 40px;
            height: 40px;
            position: relative;
            pointer-events: none;
        }

        .location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            background: #4285F4;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.5);
            z-index: 3;
        }

        .location-accuracy {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            background: rgba(66, 133, 244, 0.2);
            border-radius: 50%;
            animation: locationPulse 2s ease-out infinite;
            z-index: 1;
        }

        .location-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            margin: -15px 0 0 -8px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 20px solid #4285F4;
            transform-origin: center bottom;
            transition: transform var(--transition-fast);
            z-index: 2;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }

        @keyframes locationPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* Proximity Alerts */
        .proximity-alerts {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0) + 70px);
            left: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 995;
            max-height: 50vh;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .proximity-alerts::-webkit-scrollbar {
            display: none;
        }

        .proximity-alert {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            animation: slideInLeft 0.3s ease-out;
            position: relative;
            min-height: 80px;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .proximity-alert.water { border-left-color: var(--water-color); }
        .proximity-alert.gas { border-left-color: var(--gas-color); }
        .proximity-alert.electric { border-left-color: var(--electric-color); }
        .proximity-alert.sewer { border-left-color: var(--sewer-color); }
        .proximity-alert.telecom { border-left-color: var(--telecom-color); }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .alert-icon.water { background: var(--water-color); }
        .alert-icon.gas { background: var(--gas-color); color: #333; }
        .alert-icon.electric { background: var(--electric-color); }
        .alert-icon.sewer { background: var(--sewer-color); }
        .alert-icon.telecom { background: var(--telecom-color); }

        .alert-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .alert-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .alert-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 12px;
        }

        .alert-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .alert-label {
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .alert-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .alert-distance {
            position: absolute;
            bottom: 8px;
            right: 12px;
            background: var(--danger);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            animation: distancePulse 1s ease-in-out infinite;
        }

        @keyframes distancePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Modal Base */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }

        .modal-handle {
            width: 36px;
            height: 4px;
            background: var(--text-tertiary);
            border-radius: 2px;
            margin: 8px auto 12px;
        }

        .modal-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--bg-tertiary);
            display: flex;
            gap: 12px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            transition: all var(--transition-fast);
            -webkit-appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .select-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .select-option {
            padding: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            background: var(--bg-secondary);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 14px;
            font-weight: 500;
        }

        .select-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .image-upload {
            border: 2px dashed var(--bg-tertiary);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .image-upload i {
            font-size: 32px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            display: block;
        }

        .image-upload span {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Utility Lines */
        .utility-line {
            stroke-linecap: round;
            stroke-linejoin: round;
            cursor: pointer;
            transition: stroke-width var(--transition-fast);
        }

        .utility-line:hover {
            stroke-width: 8px !important;
        }

        .utility-line.water { stroke: var(--water-color); }
        .utility-line.gas { stroke: var(--gas-color); }
        .utility-line.electric { stroke: var(--electric-color); }
        .utility-line.sewer { stroke: var(--sewer-color); }
        .utility-line.telecom { stroke: var(--telecom-color); }

        .utility-line.main { stroke-width: 6px; }
        .utility-line.service { 
            stroke-width: 4px;
            stroke-dasharray: 8, 4;
        }

        /* Control Points */
        .control-point {
            width: 16px;
            height: 16px;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all var(--transition-fast);
        }

        .control-point:hover {
            transform: scale(1.2);
        }

        .control-point.dragging {
            transform: scale(1.5);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        /* Connection Indicator */
        .connection-indicator {
            position: absolute;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: var(--shadow-lg);
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            z-index: 1500;
            pointer-events: none;
            animation: fadeIn 0.2s ease-out;
        }

        /* Connection Popup */
        .connection-popup {
            position: absolute;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-xl);
            z-index: 1600;
            min-width: 250px;
            animation: fadeIn 0.3s ease-out;
        }

        .connection-popup-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .connection-popup-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .connection-popup-button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .connection-popup-button.primary {
            background: var(--primary);
            color: white;
        }

        .connection-popup-button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Structure Markers */
        .structure-marker {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .structure-marker:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .structure-marker i {
            font-size: 18px;
        }

        .structure-marker.water { color: var(--water-color); border: 2px solid var(--water-color); }
        .structure-marker.gas { color: var(--gas-color); border: 2px solid var(--gas-color); }
        .structure-marker.electric { color: var(--electric-color); border: 2px solid var(--electric-color); }
        .structure-marker.sewer { color: var(--sewer-color); border: 2px solid var(--sewer-color); }
        .structure-marker.telecom { color: var(--telecom-color); border: 2px solid var(--telecom-color); }

        /* Connection Point Marker */
        .connection-point {
            width: 12px;
            height: 12px;
            background: white;
            border: 3px solid;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 500;
            animation: connectionPulse 2s ease-in-out infinite;
        }

        .connection-point.water { border-color: var(--water-color); }
        .connection-point.gas { border-color: var(--gas-color); }
        .connection-point.electric { border-color: var(--electric-color); }
        .connection-point.sewer { border-color: var(--sewer-color); }
        .connection-point.telecom { border-color: var(--telecom-color); }

        @keyframes connectionPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 currentColor;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 0 8px rgba(0,0,0,0);
            }
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-primary);
            box-shadow: var(--shadow-xl);
            z-index: 3000;
            transition: left var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .side-menu.open {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            background: var(--primary);
            color: white;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .menu-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .menu-section {
            margin-bottom: 24px;
        }

        .menu-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-primary);
            text-decoration: none;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
            color: var(--text-secondary);
        }

        .menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left var(--transition-fast);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Structure Button */
        .structure-button {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0) + 90px);
            right: 80px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            font-size: 20px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 997;
        }

        .structure-button:active {
            transform: scale(0.95);
        }

        /* Structure Type Selector */
        .structure-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .structure-type-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .structure-type-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .structure-type-option i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .structure-type-option span {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 380px) {
            .utility-type-button {
                width: 42px;
                height: 42px;
                font-size: 18px;
            }
            
            .nav-button {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .proximity-alert {
                padding: 10px;
                min-height: 70px;
            }
        }

        /* Leaflet Overrides */
        .leaflet-control-attribution {
            display: none;
        }

        .leaflet-control-zoom {
            display: none;
        }

        /* Force disable text selection on map */
        .leaflet-container {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo-container">
            <div class="utility-icons">
                <div class="utility-icon water">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="utility-icon gas">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="utility-icon electric">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="utility-icon sewer">
                    <i class="fas fa-toilet"></i>
                </div>
                <div class="utility-icon telecom">
                    <i class="fas fa-phone"></i>
                </div>
            </div>
            <div class="splash-logo">
                <div class="construction-hat">
                    <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 70 Q20 50 40 40 Q60 30 80 40 Q100 50 100 70 L100 75 Q100 80 95 80 L25 80 Q20 80 20 75 Z" fill="#FFD600" stroke="#FFA000" stroke-width="2"/>
                        <rect x="45" y="35" width="30" height="45" fill="#FFA000" rx="2"/>
                        <path d="M20 70 L100 70" stroke="#FFA000" stroke-width="3"/>
                        <circle cx="60" cy="55" r="8" fill="white" opacity="0.8"/>
                    </svg>
                </div>
            </div>
        </div>
        <h1 class="splash-title">CAC Utili-Track</h1>
        <p class="splash-subtitle">Professional Utility Mapping</p>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="mode-indicator mapping" id="modeIndicator">
                    <i class="fas fa-pencil-ruler"></i>
                    <span>Mapping Mode</span>
                </div>
                <div class="top-controls">
                    <button class="control-button" id="menuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="control-button" id="layersBtn">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="control-button" id="themeBtn">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-control" id="zoomInBtn">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-control" id="zoomOutBtn">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="map-control" id="locateBtn">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>

            <!-- Proximity Alerts -->
            <div class="proximity-alerts" id="proximityAlerts"></div>

            <!-- Utility Selector -->
            <div class="utility-selector" id="utilitySelector">
                <button class="utility-type-button water active" data-type="water">
                    <i class="fas fa-tint"></i>
                </button>
                <button class="utility-type-button gas" data-type="gas">
                    <i class="fas fa-fire"></i>
                </button>
                <button class="utility-type-button electric" data-type="electric">
                    <i class="fas fa-bolt"></i>
                </button>
                <button class="utility-type-button sewer" data-type="sewer">
                    <i class="fas fa-toilet"></i>
                </button>
                <button class="utility-type-button telecom" data-type="telecom">
                    <i class="fas fa-phone"></i>
                </button>
            </div>

            <!-- Line Type Selector -->
            <div class="line-type-selector" id="lineTypeSelector">
                <button class="line-type-button active" data-type="service">Service</button>
                <button class="line-type-button" data-type="main">Main</button>
            </div>

            <!-- Structure Button -->
            <button class="structure-button" id="structureBtn">
                <i class="fas fa-cube"></i>
            </button>

            <!-- Floating Action Button -->
            <button class="fab" id="fabBtn">
                <i class="fas fa-plus"></i>
            </button>

            <!-- Bottom Navigation -->
            <div class="bottom-navigation">
                <div class="nav-pill">
                    <button class="nav-button active" data-mode="mapping" id="mappingModeBtn">
                        <i class="fas fa-pencil-ruler"></i>
                        <span>Mapping</span>
                    </button>
                    <button class="nav-button" data-mode="excavation" id="excavationModeBtn">
                        <i class="fas fa-hard-hat"></i>
                        <span>Excavation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h2 class="menu-title">CAC Utili-Track</h2>
            <p class="menu-subtitle">Professional Utility Mapping</p>
        </div>
        <div class="menu-content">
            <div class="menu-section">
                <div class="menu-section-title">Visibility</div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-tint"></i>
                    <span>Water</span>
                    <div class="toggle-switch active" data-utility="water"></div>
                </div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-fire"></i>
                    <span>Gas</span>
                    <div class="toggle-switch active" data-utility="gas"></div>
                </div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-bolt"></i>
                    <span>Electric</span>
                    <div class="toggle-switch active" data-utility="electric"></div>
                </div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-toilet"></i>
                    <span>Sewer</span>
                    <div class="toggle-switch active" data-utility="sewer"></div>
                </div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-phone"></i>
                    <span>Telecom</span>
                    <div class="toggle-switch active" data-utility="telecom"></div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Line Types</div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-grip-lines"></i>
                    <span>Main Lines</span>
                    <div class="toggle-switch active" data-linetype="main"></div>
                </div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-code-branch"></i>
                    <span>Service Lines</span>
                    <div class="toggle-switch active" data-linetype="service"></div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Structure Types</div>
                <div class="menu-item menu-toggle">
                    <i class="fas fa-cube"></i>
                    <span>Show Structures</span>
                    <div class="toggle-switch active" data-structures="all"></div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Data</div>
                <div class="menu-item" id="exportBtn">
                    <i class="fas fa-download"></i>
                    <span>Export Data</span>
                </div>
                <div class="menu-item" id="importBtn">
                    <i class="fas fa-upload"></i>
                    <span>Import Data</span>
                </div>
                <div class="menu-item" id="clearBtn">
                    <i class="fas fa-trash"></i>
                    <span>Clear All Data</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Utility Info Modal -->
    <div class="modal-overlay" id="utilityInfoModal">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Utility Information</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Depth (feet)</label>
                    <input type="number" class="form-control" id="depthInput" placeholder="3.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Size (inches)</label>
                    <input type="number" class="form-control" id="sizeInput" placeholder="4">
                </div>
                <div class="form-group">
                    <label class="form-label">Material</label>
                    <div class="select-grid">
                        <div class="select-option" data-material="PVC">PVC</div>
                        <div class="select-option" data-material="Steel">Steel</div>
                        <div class="select-option" data-material="Copper">Copper</div>
                        <div class="select-option" data-material="Concrete">Concrete</div>
                        <div class="select-option" data-material="Clay">Clay</div>
                        <div class="select-option" data-material="Other">Other</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <div class="select-grid">
                        <div class="select-option" data-condition="Good">Good</div>
                        <div class="select-option" data-condition="Fair">Fair</div>
                        <div class="select-option" data-condition="Poor">Poor</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo</label>
                    <div class="image-upload" id="imageUpload">
                        <input type="file" accept="image/*" style="display: none;" id="photoInput">
                        <i class="fas fa-camera"></i>
                        <span>Tap to add photo</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelInfoBtn">Cancel</button>
                <button class="btn btn-primary" id="saveInfoBtn">
                    <i class="fas fa-check"></i>
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Structure Modal -->
    <div class="modal-overlay" id="structureModal">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Add Structure</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Structure Type</label>
                    <div class="structure-type-grid">
                        <div class="structure-type-option" data-structure="electricalBox" data-utility="electric">
                            <i class="fas fa-box"></i>
                            <span>Electrical Box</span>
                        </div>
                        <div class="structure-type-option" data-structure="catchBasin" data-utility="sewer">
                            <i class="fas fa-water"></i>
                            <span>Catch Basin</span>
                        </div>
                        <div class="structure-type-option" data-structure="sewerManhole" data-utility="sewer">
                            <i class="fas fa-circle"></i>
                            <span>Sewer Manhole</span>
                        </div>
                        <div class="structure-type-option" data-structure="waterManhole" data-utility="water">
                            <i class="fas fa-tint"></i>
                            <span>Water Manhole</span>
                        </div>
                        <div class="structure-type-option" data-structure="gasManhole" data-utility="gas">
                            <i class="fas fa-fire"></i>
                            <span>Gas Manhole</span>
                        </div>
                        <div class="structure-type-option" data-structure="gasValve" data-utility="gas">
                            <i class="fas fa-valve"></i>
                            <span>Gas Valve</span>
                        </div>
                        <div class="structure-type-option" data-structure="hydrantValve" data-utility="water">
                            <i class="fas fa-fire-extinguisher"></i>
                            <span>Hydrant Valve</span>
                        </div>
                        <div class="structure-type-option" data-structure="telecomBox" data-utility="telecom">
                            <i class="fas fa-phone"></i>
                            <span>Telecom Box</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <input type="text" class="form-control" id="structureNotes" placeholder="Additional details...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelStructureBtn">Cancel</button>
                <button class="btn btn-primary" id="saveStructureBtn">
                    <i class="fas fa-check"></i>
                    Add Structure
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // App State
        const App = {
            mode: 'mapping',
            map: null,
            userMarker: null,
            utilities: [],
            structures: [],
            activeUtilityType: 'water',
            activeLineType: 'service',
            isDrawing: false,
            currentDrawing: [],
            currentPolyline: null,
            selectedUtility: null,
            selectedStructure: null,
            watchId: null,
            proximityCheckInterval: null,
            activeAlerts: new Map(),
            dismissedAlerts: new Map(),
            theme: 'light',
            visibility: {
                utilities: {
                    water: true,
                    gas: true,
                    electric: true,
                    sewer: true,
                    telecom: true
                },
                lineTypes: {
                    main: true,
                    service: true
                },
                structures: true
            },
            layers: {
                utilities: L.layerGroup(),
                structures: L.layerGroup()
            },
            pendingConnection: null,
            isPlacingStructure: false,
            controlPoints: []
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Hide splash screen after animation
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    initializeApp();
                }, 300);
            }, 2500);
        });

        function initializeApp() {
            initializeMap();
            setupEventListeners();
            loadSavedData();
            startLocationTracking();
        }

        // Initialize Map
        function initializeMap() {
            App.map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                tap: false,
                touchZoom: true,
                dragging: true,
                doubleClickZoom: false
            }).setView([40.7128, -74.0060], 16);

            // Add tile layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22,
                maxNativeZoom: 19
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 22,
                maxNativeZoom: 19
            });

            osmLayer.addTo(App.map);
            
            // Add utility layers to map
            App.layers.utilities.addTo(App.map);
            App.layers.structures.addTo(App.map);

            // Store layers for switching
            App.baseLayers = {
                'Street': osmLayer,
                'Satellite': satelliteLayer
            };
            App.currentBaseLayer = 'Street';

            // Map click handler
            App.map.on('click', handleMapClick);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Mode switching
            document.getElementById('mappingModeBtn').addEventListener('click', () => setMode('mapping'));
            document.getElementById('excavationModeBtn').addEventListener('click', () => setMode('excavation'));

            // Utility type selection
            document.querySelectorAll('.utility-type-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.utility-type-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    App.activeUtilityType = btn.dataset.type;
                });
            });

            // Line type selection
            document.querySelectorAll('.line-type-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.line-type-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    App.activeLineType = btn.dataset.type;
                });
            });

            // FAB button
            document.getElementById('fabBtn').addEventListener('click', handleFabClick);

            // Structure button
            document.getElementById('structureBtn').addEventListener('click', handleStructureClick);

            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => App.map.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => App.map.zoomOut());
            document.getElementById('locateBtn').addEventListener('click', centerOnUser);

            // Menu
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('sideMenu').classList.add('open');
            });

            // Close menu on outside click
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('sideMenu');
                const menuBtn = document.getElementById('menuBtn');
                if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
                    menu.classList.remove('open');
                }
            });

            // Layers button
            document.getElementById('layersBtn').addEventListener('click', toggleBaseLayer);

            // Theme toggle
            document.getElementById('themeBtn').addEventListener('click', toggleTheme);

            // Menu toggles
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggle.classList.toggle('active');
                    handleVisibilityToggle(toggle);
                });
            });

            // Data management
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);
            document.getElementById('clearBtn').addEventListener('click', clearAllData);

            // Modal controls
            document.getElementById('imageUpload').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });

            document.getElementById('cancelInfoBtn').addEventListener('click', closeUtilityModal);
            document.getElementById('saveInfoBtn').addEventListener('click', saveUtilityInfo);

            // Structure modal
            document.getElementById('cancelStructureBtn').addEventListener('click', closeStructureModal);
            document.getElementById('saveStructureBtn').addEventListener('click', saveStructure);

            // Material and condition selection
            document.querySelectorAll('.select-option').forEach(option => {
                option.addEventListener('click', () => {
                    const siblings = option.parentElement.querySelectorAll('.select-option');
                    siblings.forEach(s => s.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            // Structure type selection
            document.querySelectorAll('.structure-type-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.structure-type-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            // Prevent default touch behaviors
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('gesturechange', (e) => e.preventDefault());
            document.addEventListener('gestureend', (e) => e.preventDefault());
        }

        // Mode Management
        function setMode(mode) {
            App.mode = mode;
            
            // Update UI
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const modeIndicator = document.getElementById('modeIndicator');
            const utilitySelector = document.getElementById('utilitySelector');
            const lineTypeSelector = document.getElementById('lineTypeSelector');
            const fabBtn = document.getElementById('fabBtn');
            const structureBtn = document.getElementById('structureBtn');

            if (mode === 'mapping') {
                modeIndicator.className = 'mode-indicator mapping';
                modeIndicator.innerHTML = '<i class="fas fa-pencil-ruler"></i><span>Mapping Mode</span>';
                utilitySelector.classList.add('visible');
                lineTypeSelector.classList.add('visible');
                fabBtn.style.display = 'flex';
                structureBtn.style.display = 'flex';
                stopProximityChecking();
            } else {
                modeIndicator.className = 'mode-indicator excavation';
                modeIndicator.innerHTML = '<i class="fas fa-hard-hat"></i><span>Excavation Mode</span>';
                utilitySelector.classList.remove('visible');
                lineTypeSelector.classList.remove('visible');
                fabBtn.style.display = 'none';
                structureBtn.style.display = 'none';
                startProximityChecking();
                
                // Zoom to user location
                if (App.userMarker) {
                    App.map.setView(App.userMarker.getLatLng(), 19);
                }
            }
        }

        // Map Click Handler
        function handleMapClick(e) {
            if (App.mode === 'mapping') {
                if (App.isDrawing) {
                    addDrawingPoint(e.latlng);
                } else if (App.isPlacingStructure) {
                    placeStructure(e.latlng);
                }
            }
        }

        // FAB Click Handler
        function handleFabClick() {
            const fab = document.getElementById('fabBtn');
            
            if (App.isDrawing) {
                // Finish drawing
                finishDrawing();
            } else {
                // Start drawing
                startDrawing();
                fab.innerHTML = '<i class="fas fa-check"></i>';
                fab.classList.add('confirm');
            }
        }

        // Structure Button Handler
        function handleStructureClick() {
            if (!App.isPlacingStructure) {
                showStructureModal();
            }
        }

        // Drawing Functions
        function startDrawing() {
            App.isDrawing = true;
            App.currentDrawing = [];
            
            // Change cursor
            document.getElementById('map').style.cursor = 'crosshair';
        }

        function addDrawingPoint(latlng) {
            App.currentDrawing.push(latlng);
            
            if (App.currentPolyline) {
                App.currentPolyline.setLatLngs(App.currentDrawing);
            } else {
                App.currentPolyline = L.polyline(App.currentDrawing, {
                    color: getUtilityColor(App.activeUtilityType),
                    weight: App.activeLineType === 'main' ? 6 : 4,
                    dashArray: App.activeLineType === 'service' ? '8, 4' : null,
                    className: `utility-line ${App.activeUtilityType} ${App.activeLineType}`
                }).addTo(App.layers.utilities);
            }

            // Check for nearby connections
            if (App.currentDrawing.length > 1) {
                checkForConnections(latlng);
            }
        }

        function finishDrawing() {
            if (App.currentDrawing.length < 2) {
                cancelDrawing();
                return;
            }

            // Create utility object
            const utility = {
                id: Date.now(),
                type: App.activeUtilityType,
                lineType: App.activeLineType,
                points: App.currentDrawing,
                polyline: App.currentPolyline,
                depth: null,
                size: null,
                material: null,
                condition: null,
                photo: null,
                connections: []
            };

            // Check for pending connection
            if (App.pendingConnection) {
                createConnection(utility, App.pendingConnection);
            }

            // Add click handler for editing
            App.currentPolyline.on('click', () => selectUtility(utility));

            App.utilities.push(utility);
            
            // Show info modal
            App.selectedUtility = utility;
            showUtilityModal();

            // Reset drawing state
            resetDrawingState();
        }

        function cancelDrawing() {
            if (App.currentPolyline) {
                App.layers.utilities.removeLayer(App.currentPolyline);
            }
            resetDrawingState();
        }

        function resetDrawingState() {
            App.isDrawing = false;
            App.currentDrawing = [];
            App.currentPolyline = null;
            App.pendingConnection = null;
            
            const fab = document.getElementById('fabBtn');
            fab.innerHTML = '<i class="fas fa-plus"></i>';
            fab.classList.remove('confirm');
            
            document.getElementById('map').style.cursor = '';
            
            // Remove any connection popups
            removeConnectionPopup();
        }

        // Connection Detection and Management
        function checkForConnections(point) {
            const threshold = 20; // meters
            let nearestConnection = null;
            let minDistance = threshold;
            
            // Check utilities
            App.utilities.forEach(utility => {
                if (utility.type === App.activeUtilityType) {
                    const polyline = utility.polyline;
                    const closestPoint = findClosestPointOnPolyline(point, polyline);
                    
                    if (closestPoint.distance < minDistance) {
                        minDistance = closestPoint.distance;
                        nearestConnection = {
                            type: 'utility',
                            target: utility,
                            point: closestPoint.point,
                            distance: closestPoint.distance
                        };
                    }
                }
            });
            
            // Check structures
            App.structures.forEach(structure => {
                if (structure.utilityType === App.activeUtilityType) {
                    const distance = App.map.distance(point, structure.location);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestConnection = {
                            type: 'structure',
                            target: structure,
                            point: structure.location,
                            distance: distance
                        };
                    }
                }
            });
            
            if (nearestConnection) {
                showConnectionPopup(nearestConnection);
            }
        }

        function showConnectionPopup(connection) {
            removeConnectionPopup();
            
            const pixel = App.map.latLngToContainerPoint(connection.point);
            const popup = document.createElement('div');
            popup.className = 'connection-popup';
            popup.id = 'connectionPopup';
            
            const targetName = connection.type === 'utility' ? 
                `${connection.target.type} ${connection.target.lineType}` : 
                connection.target.name;
            
            popup.innerHTML = `
                <div class="connection-popup-title">Connect to ${targetName}?</div>
                <div class="connection-popup-buttons">
                    <button class="connection-popup-button primary" onclick="confirmConnection()">
                        <i class="fas fa-check"></i> Yes
                    </button>
                    <button class="connection-popup-button secondary" onclick="cancelConnection()">
                        <i class="fas fa-times"></i> No
                    </button>
                </div>
            `;
            
            popup.style.left = pixel.x + 'px';
            popup.style.top = (pixel.y - 120) + 'px';
            
            document.querySelector('.map-container').appendChild(popup);
            
            // Store pending connection
            App.pendingConnection = connection;
        }

        function removeConnectionPopup() {
            const popup = document.getElementById('connectionPopup');
            if (popup) {
                popup.remove();
            }
        }

        function confirmConnection() {
            removeConnectionPopup();
            // Connection will be created when drawing is finished
        }

        function cancelConnection() {
            App.pendingConnection = null;
            removeConnectionPopup();
        }

        function createConnection(utility, connection) {
            // Snap the last point to connection point
            utility.points[utility.points.length - 1] = connection.point;
            utility.polyline.setLatLngs(utility.points);
            
            // Add connection marker
            const connectionMarker = L.divIcon({
                className: `connection-point ${utility.type}`,
                html: '',
                iconSize: [12, 12]
            });
            
            L.marker(connection.point, { icon: connectionMarker }).addTo(App.layers.utilities);
            
            // Record connection
            utility.connections.push({
                type: connection.type,
                targetId: connection.target.id,
                point: connection.point
            });
            
            if (connection.type === 'utility') {
                connection.target.connections = connection.target.connections || [];
                connection.target.connections.push({
                    type: 'utility',
                    targetId: utility.id,
                    point: connection.point
                });
            }
        }

        function findClosestPointOnPolyline(point, polyline) {
            let minDistance = Infinity;
            let closestPoint = null;
            const latlngs = polyline.getLatLngs();
            
            for (let i = 0; i < latlngs.length - 1; i++) {
                const start = latlngs[i];
                const end = latlngs[i + 1];
                const closest = getClosestPointOnSegment(point, start, end);
                const distance = App.map.distance(point, closest);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoint = closest;
                }
            }
            
            return { point: closestPoint, distance: minDistance };
        }

        function getClosestPointOnSegment(point, start, end) {
            const x = point.lng;
            const y = point.lat;
            const x1 = start.lng;
            const y1 = start.lat;
            const x2 = end.lng;
            const y2 = end.lat;
            
            const A = x - x1;
            const B = y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            return L.latLng(yy, xx);
        }

        // Utility Selection and Editing
        function selectUtility(utility) {
            if (App.mode !== 'mapping') return;
            
            App.selectedUtility = utility;
            
            // Long press to edit
            let pressTimer;
            let pressStart = null;
            
            const startPress = (e) => {
                pressStart = Date.now();
                pressTimer = setTimeout(() => {
                    showUtilityModal();
                }, 500);
            };
            
            const endPress = () => {
                clearTimeout(pressTimer);
                const pressDuration = Date.now() - pressStart;
                
                // If short press, show refine controls
                if (pressDuration < 500) {
                    showRefineControls(utility);
                }
            };
            
            utility.polyline.on('mousedown', startPress);
            utility.polyline.on('mouseup', endPress);
            utility.polyline.on('mouseleave', () => clearTimeout(pressTimer));
        }

        function showRefineControls(utility) {
            // Remove existing control points
            removeControlPoints();
            
            // Add control points to each vertex
            const points = utility.polyline.getLatLngs();
            
            points.forEach((point, index) => {
                const marker = L.circleMarker(point, {
                    radius: 8,
                    fillColor: '#fff',
                    color: '#1976D2',
                    weight: 3,
                    fillOpacity: 1,
                    className: 'control-point'
                }).addTo(App.map);
                
                // Make draggable
                enableDragging(marker, (newLatLng) => {
                    points[index] = newLatLng;
                    utility.polyline.setLatLngs(points);
                });
                
                App.controlPoints.push(marker);
            });
            
            // Click elsewhere to remove control points
            App.map.once('click', removeControlPoints);
        }

        function removeControlPoints() {
            App.controlPoints.forEach(cp => App.map.removeLayer(cp));
            App.controlPoints = [];
        }

        function enableDragging(marker, onDrag) {
            let isDragging = false;
            
            marker.on('mousedown', (e) => {
                isDragging = true;
                marker._icon.classList.add('dragging');
                L.DomEvent.stop(e);
            });
            
            App.map.on('mousemove', (e) => {
                if (isDragging) {
                    marker.setLatLng(e.latlng);
                    onDrag(e.latlng);
                }
            });
            
            App.map.on('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    marker._icon.classList.remove('dragging');
                    saveData();
                }
            });
        }

        // Structure Management
        function showStructureModal() {
            document.getElementById('structureModal').classList.add('visible');
        }

        function closeStructureModal() {
            document.getElementById('structureModal').classList.remove('visible');
            App.isPlacingStructure = false;
        }

        function saveStructure() {
            const selectedType = document.querySelector('.structure-type-option.active');
            if (!selectedType) {
                alert('Please select a structure type');
                return;
            }
            
            App.isPlacingStructure = true;
            App.pendingStructure = {
                type: selectedType.dataset.structure,
                utilityType: selectedType.dataset.utility,
                notes: document.getElementById('structureNotes').value
            };
            
            closeStructureModal();
            document.getElementById('map').style.cursor = 'crosshair';
        }

        function placeStructure(location) {
            if (!App.pendingStructure) return;
            
            const structure = {
                id: Date.now(),
                type: App.pendingStructure.type,
                utilityType: App.pendingStructure.utilityType,
                location: location,
                notes: App.pendingStructure.notes,
                name: getStructureName(App.pendingStructure.type),
                connections: []
            };
            
            // Create marker
            const icon = L.divIcon({
                className: `structure-marker ${structure.utilityType}`,
                html: `<i class="fas fa-${getStructureIcon(structure.type)}"></i>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            const marker = L.marker(location, { icon: icon }).addTo(App.layers.structures);
            
            marker.on('click', () => selectStructure(structure));
            
            structure.marker = marker;
            App.structures.push(structure);
            
            // Reset
            App.isPlacingStructure = false;
            App.pendingStructure = null;
            document.getElementById('map').style.cursor = '';
            
            saveData();
        }

        function selectStructure(structure) {
            if (App.mode !== 'mapping') return;
            
            App.selectedStructure = structure;
            // Could show structure info modal here
        }

        function getStructureName(type) {
            const names = {
                electricalBox: 'Electrical Box',
                catchBasin: 'Catch Basin',
                sewerManhole: 'Sewer Manhole',
                waterManhole: 'Water Manhole',
                gasManhole: 'Gas Manhole',
                gasValve: 'Gas Valve Box',
                hydrantValve: 'Hydrant Valve Box',
                telecomBox: 'Telecom Box'
            };
            return names[type] || type;
        }

        function getStructureIcon(type) {
            const icons = {
                electricalBox: 'box',
                catchBasin: 'water',
                sewerManhole: 'circle',
                waterManhole: 'tint',
                gasManhole: 'fire',
                gasValve: 'valve',
                hydrantValve: 'fire-extinguisher',
                telecomBox: 'phone'
            };
            return icons[type] || 'cube';
        }

        // Utility Info Modal
        function showUtilityModal() {
            const modal = document.getElementById('utilityInfoModal');
            modal.classList.add('visible');
            
            // Load existing data if editing
            if (App.selectedUtility) {
                document.getElementById('depthInput').value = App.selectedUtility.depth || '';
                document.getElementById('sizeInput').value = App.selectedUtility.size || '';
                
                // Clear previous selections
                document.querySelectorAll('.select-option').forEach(opt => opt.classList.remove('active'));
                
                // Set material
                if (App.selectedUtility.material) {
                    document.querySelector(`[data-material="${App.selectedUtility.material}"]`)?.classList.add('active');
                }
                
                // Set condition
                if (App.selectedUtility.condition) {
                    document.querySelector(`[data-condition="${App.selectedUtility.condition}"]`)?.classList.add('active');
                }
            }
        }

        function closeUtilityModal() {
            document.getElementById('utilityInfoModal').classList.remove('visible');
        }

        function saveUtilityInfo() {
            if (!App.selectedUtility) return;
            
            App.selectedUtility.depth = document.getElementById('depthInput').value;
            App.selectedUtility.size = document.getElementById('sizeInput').value;
            App.selectedUtility.material = document.querySelector('.select-option[data-material].active')?.dataset.material;
            App.selectedUtility.condition = document.querySelector('.select-option[data-condition].active')?.dataset.condition;
            
            // Handle photo
            const photoInput = document.getElementById('photoInput');
            if (photoInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    App.selectedUtility.photo = e.target.result;
                };
                reader.readAsDataURL(photoInput.files[0]);
            }
            
            saveData();
            closeUtilityModal();
        }

        // Location Tracking
        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            App.watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
            
            // Also track device orientation for direction
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', updateUserDirection);
            }
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            if (!App.userMarker) {
                // Create custom user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `
                        <div class="location-accuracy"></div>
                        <div class="location-direction" id="locationDirection"></div>
                        <div class="location-dot"></div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                App.userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(App.map);
            } else {
                App.userMarker.setLatLng([lat, lng]);
            }
            
            // Update accuracy circle size
            const accuracyElement = App.userMarker._icon.querySelector('.location-accuracy');
            if (accuracyElement) {
                const scale = Math.min(3, Math.max(1, accuracy / 10));
                accuracyElement.style.transform = `scale(${scale})`;
            }
        }

        function updateUserDirection(event) {
            const heading = event.webkitCompassHeading || event.alpha;
            if (heading && App.userMarker) {
                const directionElement = document.getElementById('locationDirection');
                if (directionElement) {
                    directionElement.style.transform = `rotate(${heading}deg)`;
                }
            }
        }

        function handleLocationError(error) {
            console.error('Location error:', error);
        }

        function centerOnUser() {
            if (App.userMarker) {
                App.map.setView(App.userMarker.getLatLng(), 18);
            }
        }

        // Proximity Checking (Excavation Mode)
        function startProximityChecking() {
            App.proximityCheckInterval = setInterval(checkProximity, 1000);
        }

        function stopProximityChecking() {
            if (App.proximityCheckInterval) {
                clearInterval(App.proximityCheckInterval);
                App.proximityCheckInterval = null;
            }
            clearProximityAlerts();
        }

        function checkProximity() {
            if (!App.userMarker) return;
            
            const userPos = App.userMarker.getLatLng();
            const alertRadius = 15; // feet
            const alertRadiusMeters = alertRadius * 0.3048; // Convert to meters
            
            App.utilities.forEach(utility => {
                // Check if visible
                if (!App.visibility.utilities[utility.type]) return;
                if (!App.visibility.lineTypes[utility.lineType]) return;
                
                // Check if dismissed
                const dismissedUntil = App.dismissedAlerts.get(utility.id);
                if (dismissedUntil && Date.now() < dismissedUntil) return;
                
                // Find closest point on utility
                const closest = findClosestPointOnPolyline(userPos, utility.polyline);
                
                if (closest.distance <= alertRadiusMeters) {
                    if (!App.activeAlerts.has(utility.id)) {
                        showProximityAlert(utility, closest.distance);
                    } else {
                        updateProximityAlert(utility, closest.distance);
                    }
                } else {
                    // Outside radius - start removal timer
                    const alert = App.activeAlerts.get(utility.id);
                    if (alert && !alert.removalTimer) {
                        alert.removalTimer = setTimeout(() => {
                            removeProximityAlert(utility.id);
                        }, 45000); // 45 seconds
                    }
                }
            });
        }

        function showProximityAlert(utility, distance) {
            const alertsContainer = document.getElementById('proximityAlerts');
            
            // Limit to 5 alerts
            if (alertsContainer.children.length >= 5) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
            
            const alert = document.createElement('div');
            alert.className = `proximity-alert ${utility.type}`;
            alert.id = `alert-${utility.id}`;
            
            const distanceFeet = Math.round(distance * 3.28084);
            
            alert.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">
                        <div class="alert-icon ${utility.type}">
                            <i class="fas fa-${getUtilityIcon(utility.type)}"></i>
                        </div>
                        <span>${utility.type.charAt(0).toUpperCase() + utility.type.slice(1)} ${utility.lineType}</span>
                    </div>
                    <button class="alert-close" onclick="dismissAlert(${utility.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="alert-content">
                    <div class="alert-item">
                        <div class="alert-label">Depth</div>
                        <div class="alert-value">${utility.depth || 'Unknown'} ft</div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-label">Size</div>
                        <div class="alert-value">${utility.size || 'Unknown'} in</div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-label">Material</div>
                        <div class="alert-value">${utility.material || 'Unknown'}</div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-label">Condition</div>
                        <div class="alert-value">${utility.condition || 'Unknown'}</div>
                    </div>
                </div>
                <div class="alert-distance">${distanceFeet} ft</div>
            `;
            
            alertsContainer.insertBefore(alert, alertsContainer.firstChild);
            
            // Store alert
            App.activeAlerts.set(utility.id, {
                element: alert,
                utility: utility,
                removalTimer: null
            });
            
            // Vibrate if available
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function updateProximityAlert(utility, distance) {
            const alert = App.activeAlerts.get(utility.id);
            if (!alert) return;
            
            const distanceElement = alert.element.querySelector('.alert-distance');
            if (distanceElement) {
                const distanceFeet = Math.round(distance * 3.28084);
                distanceElement.textContent = `${distanceFeet} ft`;
            }
            
            // Cancel removal timer if back in range
            if (alert.removalTimer) {
                clearTimeout(alert.removalTimer);
                alert.removalTimer = null;
            }
        }

        function removeProximityAlert(utilityId) {
            const alert = App.activeAlerts.get(utilityId);
            if (!alert) return;
            
            alert.element.style.animation = 'slideInLeft 0.3s ease-out reverse';
            setTimeout(() => {
                alert.element.remove();
                App.activeAlerts.delete(utilityId);
            }, 300);
        }

        function dismissAlert(utilityId) {
            // Set 3-minute cooldown
            App.dismissedAlerts.set(utilityId, Date.now() + 180000);
            removeProximityAlert(utilityId);
        }

        function clearProximityAlerts() {
            App.activeAlerts.forEach((alert, id) => {
                removeProximityAlert(id);
            });
        }

        // Utility Helpers
        function getUtilityColor(type) {
            const colors = {
                water: '#2196F3',
                gas: '#FFD600',
                electric: '#F44336',
                sewer: '#795548',
                telecom: '#9C27B0'
            };
            return colors[type] || '#000';
        }

        function getUtilityIcon(type) {
            const icons = {
                water: 'tint',
                gas: 'fire',
                electric: 'bolt',
                sewer: 'toilet',
                telecom: 'phone'
            };
            return icons[type] || 'question';
        }

        // Theme Management
        function toggleTheme() {
            App.theme = App.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', App.theme);
            
            const themeBtn = document.getElementById('themeBtn');
            themeBtn.innerHTML = App.theme === 'light' ? 
                '<i class="fas fa-moon"></i>' : 
                '<i class="fas fa-sun"></i>';
            
            saveData();
        }

        // Layer Management
        function toggleBaseLayer() {
            App.currentBaseLayer = App.currentBaseLayer === 'Street' ? 'Satellite' : 'Street';
            
            Object.values(App.baseLayers).forEach(layer => {
                App.map.removeLayer(layer);
            });
            
            App.baseLayers[App.currentBaseLayer].addTo(App.map);
        }

        // Visibility Management
        function handleVisibilityToggle(toggle) {
            const isActive = toggle.classList.contains('active');
            
            if (toggle.dataset.utility) {
                App.visibility.utilities[toggle.dataset.utility] = isActive;
            } else if (toggle.dataset.linetype) {
                App.visibility.lineTypes[toggle.dataset.linetype] = isActive;
            } else if (toggle.dataset.structures) {
                App.visibility.structures = isActive;
            }
            
            updateVisibility();
            saveData();
        }

        function updateVisibility() {
            // Update utilities
            App.utilities.forEach(utility => {
                const isVisible = App.visibility.utilities[utility.type] && 
                                App.visibility.lineTypes[utility.lineType];
                
                if (isVisible) {
                    if (!App.layers.utilities.hasLayer(utility.polyline)) {
                        App.layers.utilities.addLayer(utility.polyline);
                    }
                } else {
                    if (App.layers.utilities.hasLayer(utility.polyline)) {
                        App.layers.utilities.removeLayer(utility.polyline);
                    }
                }
            });
            
            // Update structures
            if (App.visibility.structures) {
                if (!App.map.hasLayer(App.layers.structures)) {
                    App.map.addLayer(App.layers.structures);
                }
            } else {
                if (App.map.hasLayer(App.layers.structures)) {
                    App.map.removeLayer(App.layers.structures);
                }
            }
        }

        // Data Management
        function saveData() {
            const data = {
                utilities: App.utilities.map(u => ({
                    id: u.id,
                    type: u.type,
                    lineType: u.lineType,
                    points: u.points,
                    depth: u.depth,
                    size: u.size,
                    material: u.material,
                    condition: u.condition,
                    photo: u.photo,
                    connections: u.connections
                })),
                structures: App.structures.map(s => ({
                    id: s.id,
                    type: s.type,
                    utilityType: s.utilityType,
                    location: s.location,
                    notes: s.notes,
                    name: s.name,
                    connections: s.connections
                })),
                theme: App.theme,
                visibility: App.visibility
            };
            
            localStorage.setItem('cacUtiliTrackData', JSON.stringify(data));
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('cacUtiliTrackData');
            if (!savedData) return;
            
            try {
                const data = JSON.parse(savedData);
                
                // Load theme
                if (data.theme) {
                    App.theme = data.theme;
                    document.body.setAttribute('data-theme', App.theme);
                    const themeBtn = document.getElementById('themeBtn');
                    themeBtn.innerHTML = App.theme === 'light' ? 
                        '<i class="fas fa-moon"></i>' : 
                        '<i class="fas fa-sun"></i>';
                }
                
                // Load visibility settings
                if (data.visibility) {
                    App.visibility = data.visibility;
                    updateVisibilityToggles();
                }
                
                // Load utilities
                if (data.utilities) {
                    data.utilities.forEach(utilityData => {
                        const polyline = L.polyline(utilityData.points, {
                            color: getUtilityColor(utilityData.type),
                            weight: utilityData.lineType === 'main' ? 6 : 4,
                            dashArray: utilityData.lineType === 'service' ? '8, 4' : null,
                            className: `utility-line ${utilityData.type} ${utilityData.lineType}`
                        }).addTo(App.layers.utilities);
                        
                        const utility = {
                            ...utilityData,
                            polyline: polyline
                        };
                        
                        polyline.on('click', () => selectUtility(utility));
                        
                        App.utilities.push(utility);
                        
                        // Add connection markers
                        if (utility.connections) {
                            utility.connections.forEach(conn => {
                                const connectionMarker = L.divIcon({
                                    className: `connection-point ${utility.type}`,
                                    html: '',
                                    iconSize: [12, 12]
                                });
                                
                                L.marker(conn.point, { icon: connectionMarker }).addTo(App.layers.utilities);
                            });
                        }
                    });
                }
                
                // Load structures
                if (data.structures) {
                    data.structures.forEach(structureData => {
                        const icon = L.divIcon({
                            className: `structure-marker ${structureData.utilityType}`,
                            html: `<i class="fas fa-${getStructureIcon(structureData.type)}"></i>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });
                        
                        const marker = L.marker(structureData.location, { icon: icon }).addTo(App.layers.structures);
                        
                        const structure = {
                            ...structureData,
                            marker: marker
                        };
                        
                        marker.on('click', () => selectStructure(structure));
                        
                        App.structures.push(structure);
                    });
                }
                
                updateVisibility();
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        function updateVisibilityToggles() {
            // Update utility toggles
            Object.entries(App.visibility.utilities).forEach(([type, visible]) => {
                const toggle = document.querySelector(`.toggle-switch[data-utility="${type}"]`);
                if (toggle) {
                    toggle.classList.toggle('active', visible);
                }
            });
            
            // Update line type toggles
            Object.entries(App.visibility.lineTypes).forEach(([type, visible]) => {
                const toggle = document.querySelector(`.toggle-switch[data-linetype="${type}"]`);
                if (toggle) {
                    toggle.classList.toggle('active', visible);
                }
            });
            
            // Update structures toggle
            const structureToggle = document.querySelector('.toggle-switch[data-structures="all"]');
            if (structureToggle) {
                structureToggle.classList.toggle('active', App.visibility.structures);
            }
        }

        function exportData() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                utilities: App.utilities.map(u => ({
                    id: u.id,
                    type: u.type,
                    lineType: u.lineType,
                    points: u.points,
                    depth: u.depth,
                    size: u.size,
                    material: u.material,
                    condition: u.condition,
                    photo: u.photo,
                    connections: u.connections
                })),
                structures: App.structures.map(s => ({
                    id: s.id,
                    type: s.type,
                    utilityType: s.utilityType,
                    location: s.location,
                    notes: s.notes,
                    name: s.name,
                    connections: s.connections
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cac-utilitrack-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Clear existing data
                        clearAllData(false);
                        
                        // Import utilities
                        if (data.utilities) {
                            data.utilities.forEach(utilityData => {
                                const polyline = L.polyline(utilityData.points, {
                                    color: getUtilityColor(utilityData.type),
                                    weight: utilityData.lineType === 'main' ? 6 : 4,
                                    dashArray: utilityData.lineType === 'service' ? '8, 4' : null,
                                    className: `utility-line ${utilityData.type} ${utilityData.lineType}`
                                }).addTo(App.layers.utilities);
                                
                                const utility = {
                                    ...utilityData,
                                    polyline: polyline
                                };
                                
                                polyline.on('click', () => selectUtility(utility));
                                
                                App.utilities.push(utility);
                                
                                // Add connection markers
                                if (utility.connections) {
                                    utility.connections.forEach(conn => {
                                        const connectionMarker = L.divIcon({
                                            className: `connection-point ${utility.type}`,
                                            html: '',
                                            iconSize: [12, 12]
                                        });
                                        
                                        L.marker(conn.point, { icon: connectionMarker }).addTo(App.layers.utilities);
                                    });
                                }
                            });
                        }
                        
                        // Import structures
                        if (data.structures) {
                            data.structures.forEach(structureData => {
                                const icon = L.divIcon({
                                    className: `structure-marker ${structureData.utilityType}`,
                                    html: `<i class="fas fa-${getStructureIcon(structureData.type)}"></i>`,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16]
                                });
                                
                                const marker = L.marker(structureData.location, { icon: icon }).addTo(App.layers.structures);
                                
                                const structure = {
                                    ...structureData,
                                    marker: marker
                                };
                                
                                marker.on('click', () => selectStructure(structure));
                                
                                App.structures.push(structure);
                            });
                        }
                        
                        saveData();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                        console.error('Import error:', error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData(confirm = true) {
            if (confirm && !window.confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                return;
            }
            
            // Clear utilities
            App.utilities.forEach(utility => {
                if (utility.polyline) {
                    App.layers.utilities.removeLayer(utility.polyline);
                }
            });
            
            // Clear structures
            App.structures.forEach(structure => {
                if (structure.marker) {
                    App.layers.structures.removeLayer(structure.marker);
                }
            });
            
            // Clear control points
            removeControlPoints();
            
            App.utilities = [];
            App.structures = [];
            
            // Clear local storage
            localStorage.removeItem('cacUtiliTrackData');
            
            if (confirm) {
                alert('All data has been cleared.');
            }
        }

        // Make functions global for inline onclick handlers
        window.dismissAlert = dismissAlert;
        window.confirmConnection = confirmConnection;
        window.cancelConnection = cancelConnection;
    </script>
</body>
</html>
