<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAC Utili-Track</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-blue: #0066cc;
            --water-blue: #1E90FF;
            --gas-yellow: #FFD700;
            --electric-red: #DC143C;
            --sewer-brown: #8B4513;
            --telephone-purple: #9370DB;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --danger-red: #f44336;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.2);
        }

        body.dark-mode {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 0.5s ease-out 3.5s forwards;
        }

        .splash-logo {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
        }

        .construction-icon {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotateGear 4s linear infinite;
        }

        .construction-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 0 10px rgba(255, 215, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        .construction-icon::after {
            content: '‚öôÔ∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            animation: rotateGear 3s linear infinite reverse;
        }

        .pipe-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .pipe {
            position: absolute;
            height: 8px;
            background: linear-gradient(90deg, transparent 0%, var(--water-blue) 20%, var(--gas-yellow) 40%, var(--electric-red) 60%, var(--sewer-brown) 80%, transparent 100%);
            animation: flowPipe 3s linear infinite;
        }

        .pipe:nth-child(1) {
            top: 30%;
            width: 150%;
            left: -25%;
        }

        .pipe:nth-child(2) {
            bottom: 30%;
            width: 150%;
            right: -25%;
            animation-delay: 1.5s;
        }

        .app-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: slideInUp 1s ease-out 0.5s both;
        }

        .app-subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            animation: slideInUp 1s ease-out 0.7s both;
        }

        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 30px;
            overflow: hidden;
            animation: slideInUp 1s ease-out 0.9s both;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 2px;
            animation: loadProgress 3s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @keyframes rotateGear {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        @keyframes flowPipe {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes loadProgress {
            from { width: 0; }
            to { width: 100%; }
        }

        /* Main App Container */
        .app-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary), 0.95);
        }

        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .mode-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            animation: modeIconPulse 2s ease-in-out infinite;
        }

        .mode-icon.mapping {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .mode-icon.excavation {
            background: linear-gradient(135deg, #FF9800, #FFC107);
        }

        @keyframes modeIconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .top-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .icon-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .icon-btn:active::before {
            width: 100%;
            height: 100%;
        }

        .icon-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary), 0.95);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-blue);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--primary-blue);
            border-radius: 0 0 3px 3px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        .nav-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .nav-item:active .nav-icon {
            transform: scale(0.9);
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Utility Panel */
        .utility-panel {
            position: absolute;
            left: 10px;
            top: 70px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 15px;
            z-index: 999;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            transition: all 0.3s ease;
            transform: translateX(0);
        }

        .utility-panel.hidden {
            transform: translateX(-120%);
        }

        .panel-header {
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .utility-type {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .utility-type:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .utility-type.selected {
            background: var(--primary-blue);
            color: white;
        }

        .utility-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .utility-toggle {
            margin-left: auto;
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .utility-toggle.active {
            background: var(--success-green);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .utility-toggle.active .toggle-slider {
            transform: translateX(20px);
        }

        /* Drawing Controls */
        .drawing-controls {
            position: absolute;
            right: 10px;
            top: 70px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            transform: translateX(0);
        }

        .drawing-controls.hidden {
            transform: translateX(120%);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: none;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .control-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        .control-btn.danger {
            background: var(--danger-red);
            color: white;
        }

        /* Service/Main Toggle */
        .type-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
            margin-top: 10px;
        }

        .type-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .type-option.active {
            background: var(--primary-blue);
            color: white;
        }

        /* Proximity Warnings */
        .proximity-warnings {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 20px);
            max-width: 400px;
            z-index: 998;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .warning-box {
            background: var(--bg-primary);
            border-left: 4px solid var(--warning-orange);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            animation: slideInDown 0.3s ease;
            pointer-events: all;
            position: relative;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .warning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .warning-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-icon {
            width: 24px;
            height: 24px;
            background: var(--warning-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            animation: warningPulse 2s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .close-warning {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .close-warning:hover {
            color: var(--danger-red);
        }

        .warning-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .warning-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 16px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--bg-primary);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .image-upload {
            position: relative;
            width: 100%;
            height: 150px;
            border: 2px dashed var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .image-upload:hover {
            border-color: var(--primary-blue);
            background: var(--bg-secondary);
        }

        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Structure Icons */
        .structure-panel {
            position: absolute;
            left: 10px;
            bottom: 80px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 10px;
            z-index: 999;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 200px;
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .structure-panel.hidden {
            transform: translateY(120%);
        }

        .structure-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .structure-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .structure-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            right: 10px;
            bottom: 80px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-style-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-style-btn:hover {
            background: var(--bg-tertiary);
        }

        .map-style-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        /* User Location Marker */
        .user-location-marker {
            width: 20px;
            height: 20px;
            background: var(--primary-blue);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }

        .user-direction {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 15px solid var(--primary-blue);
            transform-origin: bottom center;
        }

        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 102, 204, 0.3);
            border-radius: 50%;
            animation: locationPulse 2s ease-out infinite;
        }

        @keyframes locationPulse {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        /* Utility Line Styles */
        .utility-line {
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            cursor: pointer;
            transition: stroke-width 0.3s ease;
        }

        .utility-line:hover {
            stroke-width: 6;
        }

        .utility-line.water { stroke: var(--water-blue); }
        .utility-line.gas { stroke: var(--gas-yellow); }
        .utility-line.electric { stroke: var(--electric-red); }
        .utility-line.sewer { stroke: var(--sewer-brown); }
        .utility-line.telephone { stroke: var(--telephone-purple); }

        .utility-line.service {
            stroke-dasharray: 5, 5;
        }

        /* Connection Dialog */
        .connection-dialog {
            position: absolute;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .connection-dialog h4 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .connection-actions {
            display: flex;
            gap: 10px;
        }

        /* Refine Points */
        .refine-point {
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid var(--primary-blue);
            border-radius: 50%;
            cursor: move;
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .refine-point:hover {
            transform: translate(-50%, -50%) scale(1.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .refine-point.dragging {
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%) scale(1.8);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: var(--bg-primary);
            box-shadow: -4px 0 16px rgba(0,0,0,0.1);
            z-index: 1002;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-content {
            padding: 20px;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .dark-mode-toggle.active {
            background: var(--primary-blue);
        }

        .dark-mode-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .dark-mode-toggle.active .dark-mode-slider {
            transform: translateX(24px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .utility-panel {
                max-width: 160px;
            }
            
            .warning-box {
                font-size: 14px;
            }
            
            .modal {
                padding: 15px;
            }
        }

        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none;
        }

        /* Custom map styles */
        .leaflet-container {
            background: var(--bg-secondary);
        }

        /* Structure Markers */
        .structure-marker {
            background: white;
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            padding: 4px;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .structure-marker:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        /* Edit mode overlay */
        .edit-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 997;
            display: none;
        }

        .edit-overlay.active {
            display: block;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2001;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid var(--success-green);
        }

        .notification.error {
            border-left: 4px solid var(--danger-red);
        }

        .notification.info {
            border-left: 4px solid var(--primary-blue);
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility Info Popup */
        .utility-info-popup {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .info-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--bg-tertiary);
        }

        /* Touch feedback */
        .touchable {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .touchable:active {
            opacity: 0.8;
        }

        /* Prevent zoom */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            font-size: 16px !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Excavation mode specific styles */
        .excavation-mode #map {
            filter: brightness(1.1) contrast(1.1);
        }

        .excavation-radius {
            fill: rgba(255, 152, 0, 0.1);
            stroke: var(--warning-orange);
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            animation: radiusPulse 2s ease-in-out infinite;
        }

        @keyframes radiusPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Utility segment highlight */
        .utility-segment-highlight {
            stroke-width: 8;
            stroke: rgba(255, 255, 255, 0.5);
            fill: none;
            pointer-events: none;
            animation: segmentGlow 2s ease-in-out infinite;
        }

        @keyframes segmentGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* GPS accuracy indicator */
        .gps-accuracy {
            position: absolute;
            top: 120px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: var(--shadow-md);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 998;
        }

        .accuracy-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: accuracyPulse 2s ease-in-out infinite;
        }

        .accuracy-dot.good {
            background: var(--success-green);
        }

        .accuracy-dot.medium {
            background: var(--warning-orange);
        }

        .accuracy-dot.poor {
            background: var(--danger-red);
        }

        @keyframes accuracyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <div class="construction-icon"></div>
            <div class="pipe-animation">
                <div class="pipe"></div>
                <div class="pipe"></div>
            </div>
        </div>
        <h1 class="app-title">CAC Utili-Track</h1>
        <p class="app-subtitle">Professional Utility Mapping System</p>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Map -->
        <div id="map"></div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="mode-indicator">
                <div class="mode-icon mapping" id="modeIcon">üó∫Ô∏è</div>
                <span id="modeText">Mapping Mode</span>
            </div>
            <div class="top-actions">
                <button class="icon-btn touchable" id="menuBtn">‚ò∞</button>
                <button class="icon-btn touchable" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- GPS Accuracy Indicator -->
        <div class="gps-accuracy" id="gpsAccuracy">
            <div class="accuracy-dot good" id="accuracyDot"></div>
            <span id="accuracyText">GPS: Good</span>
        </div>

        <!-- Utility Panel -->
        <div class="utility-panel" id="utilityPanel">
            <div class="panel-header">
                <span>Utilities</span>
                <button class="icon-btn touchable" onclick="togglePanel('utilityPanel')" style="width: 24px; height: 24px; font-size: 16px;">√ó</button>
            </div>
            <div id="utilityList"></div>
        </div>

        <!-- Drawing Controls -->
        <div class="drawing-controls" id="drawingControls">
            <button class="control-btn touchable" id="drawBtn" title="Draw Utility">‚úèÔ∏è</button>
            <button class="control-btn touchable" id="selectBtn" title="Select/Edit">üëÜ</button>
            <button class="control-btn touchable" id="refineBtn" title="Refine Location">üìç</button>
            <button class="control-btn touchable danger" id="deleteBtn" title="Delete">üóëÔ∏è</button>
            <div class="type-toggle">
                <div class="type-option active touchable" id="mainType" onclick="setUtilityType('main')">Main</div>
                <div class="type-option touchable" id="serviceType" onclick="setUtilityType('service')">Service</div>
            </div>
        </div>

        <!-- Structure Panel -->
        <div class="structure-panel" id="structurePanel">
            <button class="structure-btn touchable" data-structure="electrical-box" title="Electrical Box">‚ö°</button>
            <button class="structure-btn touchable" data-structure="catch-basin" title="Catch Basin">üåä</button>
            <button class="structure-btn touchable" data-structure="sewer-manhole" title="Sewer Manhole">üï≥Ô∏è</button>
            <button class="structure-btn touchable" data-structure="water-manhole" title="Water Manhole">üíß</button>
            <button class="structure-btn touchable" data-structure="gas-manhole" title="Gas Manhole">üî•</button>
            <button class="structure-btn touchable" data-structure="gas-valve" title="Gas Valve Box">üîß</button>
            <button class="structure-btn touchable" data-structure="hydrant-valve" title="Hydrant Valve Box">üöø</button>
        </div>

        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-style-btn touchable active" data-style="street">Street</button>
            <button class="map-style-btn touchable" data-style="satellite">Satellite</button>
            <button class="map-style-btn touchable" data-style="hybrid">Hybrid</button>
        </div>

        <!-- Proximity Warnings -->
        <div class="proximity-warnings" id="proximityWarnings"></div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active touchable" id="navMapping" onclick="switchMode('mapping')">
                <span class="nav-icon">üó∫Ô∏è</span>
                <span class="nav-label">Mapping</span>
            </div>
            <div class="nav-item touchable" id="navExcavation" onclick="switchMode('excavation')">
                <span class="nav-icon">üöß</span>
                <span class="nav-label">Excavation</span>
            </div>
            <div class="nav-item touchable" id="navUtilities" onclick="togglePanel('utilityPanel')">
                <span class="nav-icon">üîß</span>
                <span class="nav-label">Utilities</span>
            </div>
            <div class="nav-item touchable" id="navStructures" onclick="togglePanel('structurePanel')">
                <span class="nav-icon">üèóÔ∏è</span>
                <span class="nav-label">Structures</span>
            </div>
        </nav>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="icon-btn touchable" onclick="toggleSettings()">√ó</button>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-label">
                        <span>Dark Mode</span>
                        <div class="dark-mode-toggle touchable" id="darkModeToggle" onclick="toggleDarkMode()">
                            <div class="dark-mode-slider">
                                <span id="darkModeIcon">‚òÄÔ∏è</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <span>High Accuracy GPS</span>
                        <div class="utility-toggle active touchable" onclick="toggleGPSAccuracy(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <span>Auto-Connect Utilities</span>
                        <div class="utility-toggle active touchable" onclick="toggleAutoConnect(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <span>Proximity Alert Distance</span>
                    </div>
                    <input type="range" class="form-input" min="5" max="30" value="15" id="proximityRange">
                    <div style="text-align: center; margin-top: 5px; font-size: 14px;">
                        <span id="proximityValue">15</span> feet
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Utility Info -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal">
                <div class="modal-header">
                    <span id="modalTitle">Utility Information</span>
                    <button class="icon-btn touchable" onclick="closeModal()" style="width: 32px; height: 32px;">√ó</button>
                </div>
                <form id="utilityForm">
                    <div class="form-group">
                        <label class="form-label">Depth (feet)</label>
                        <input type="number" class="form-input" id="utilityDepth" placeholder="Enter depth">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Size (inches)</label>
                        <input type="number" class="form-input" id="utilitySize" placeholder="Enter size">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Material</label>
                        <select class="form-select" id="utilityMaterial">
                            <option value="">Select material</option>
                            <option value="PVC">PVC</option>
                            <option value="HDPE">HDPE</option>
                            <option value="Steel">Steel</option>
                            <option value="Cast Iron">Cast Iron</option>
                            <option value="Copper">Copper</option>
                            <option value="Concrete">Concrete</option>
                            <option value="Clay">Clay</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condition</label>
                        <select class="form-select" id="utilityCondition">
                            <option value="">Select condition</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image</label>
                        <div class="image-upload touchable" onclick="document.getElementById('utilityImage').click()">
                            <input type="file" id="utilityImage" accept="image/*" style="display: none;" onchange="previewImage(event)">
                            <div class="upload-placeholder" id="imagePlaceholder">
                                <div>üì∑</div>
                                <div>Tap to upload image</div>
                            </div>
                            <img class="image-preview" id="imagePreview" style="display: none;">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary touchable" onclick="closeModal()">Cancel</button>
                        <button type="button" class="btn btn-primary touchable" onclick="saveUtilityInfo()">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <span id="notificationIcon">‚ÑπÔ∏è</span>
            <span id="notificationText"></span>
        </div>

        <!-- Edit Overlay -->
        <div class="edit-overlay" id="editOverlay"></div>
    </div>

    <script>
        // Global variables
        let map;
        let userLocationMarker;
        let userLocationCircle;
        let currentMode = 'mapping';
        let drawingMode = false;
        let selectedUtilityType = 'water';
        let selectedUtilityClass = 'main';
        let currentDrawing = [];
        let utilities = [];
        let structures = [];
        let selectedUtility = null;
        let refineMode = false;
        let deleteMode = false;
        let proximityWarnings = new Map();
        let warningCooldowns = new Map();
        let gpsWatchId = null;
        let deviceOrientation = 0;
        let autoConnect = true;
        let proximityDistance = 15;
        let highAccuracyGPS = true;

        // Utility types configuration
        const utilityTypes = {
            water: { name: 'Water', color: '#1E90FF', icon: 'üíß' },
            gas: { name: 'Gas', color: '#FFD700', icon: 'üî•' },
            electric: { name: 'Electric', color: '#DC143C', icon: '‚ö°' },
            sewer: { name: 'Sewer', color: '#8B4513', icon: 'üí©' },
            telephone: { name: 'Telephone', color: '#9370DB', icon: 'üìû' }
        };

        // Structure types configuration
        const structureTypes = {
            'electrical-box': { name: 'Electrical Box', icon: '‚ö°', color: '#DC143C' },
            'catch-basin': { name: 'Catch Basin', icon: 'üåä', color: '#1E90FF' },
            'sewer-manhole': { name: 'Sewer Manhole', icon: 'üï≥Ô∏è', color: '#8B4513' },
            'water-manhole': { name: 'Water Manhole', icon: 'üíß', color: '#1E90FF' },
            'gas-manhole': { name: 'Gas Manhole', icon: 'üî•', color: '#FFD700' },
            'gas-valve': { name: 'Gas Valve Box', icon: 'üîß', color: '#FFD700' },
            'hydrant-valve': { name: 'Hydrant Valve Box', icon: 'üöø', color: '#1E90FF' }
        };

        // Initialize app
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initializeApp();
            }, 4000);
        });

        function initializeApp() {
            initializeMap();
            initializeGeolocation();
            initializeDeviceOrientation();
            populateUtilityPanel();
            initializeStructures();
            initializeEventListeners();
            loadSavedData();
            
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').classList.add('active');
                document.getElementById('darkModeIcon').textContent = 'üåô';
            }
        }

        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([40.7128, -74.0060], 15);

            // Add street layer by default
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Add custom zoom control
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // Map click handler
            map.on('click', handleMapClick);
            
            // Long press handler for utilities
            let pressTimer;
            map.on('mousedown touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    handleLongPress(e);
                }, 500);
            });
            
            map.on('mouseup touchend mousemove touchmove', () => {
                clearTimeout(pressTimer);
            });
        }

        function initializeGeolocation() {
            if ('geolocation' in navigator) {
                const options = {
                    enableHighAccuracy: highAccuracyGPS,
                    timeout: 5000,
                    maximumAge: 0
                };

                gpsWatchId = navigator.geolocation.watchPosition(
                    updateUserLocation,
                    handleGeolocationError,
                    options
                );
            } else {
                showNotification('Geolocation not supported', 'error');
            }
        }

        function updateUserLocation(position) {
            const { latitude, longitude, accuracy } = position.coords;
            const userLatLng = [latitude, longitude];

            if (!userLocationMarker) {
                // Create user location marker
                const locationIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: '<div class="location-pulse"></div><div class="user-direction" id="userDirection"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                userLocationMarker = L.marker(userLatLng, { icon: locationIcon }).addTo(map);
                userLocationCircle = L.circle(userLatLng, {
                    radius: accuracy,
                    color: '#0066cc',
                    fillColor: '#0066cc',
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(map);

                map.setView(userLatLng, 18);
            } else {
                userLocationMarker.setLatLng(userLatLng);
                userLocationCircle.setLatLng(userLatLng);
                userLocationCircle.setRadius(accuracy);
            }

            // Update GPS accuracy indicator
            updateGPSAccuracy(accuracy);

            // Check proximity in excavation mode
            if (currentMode === 'excavation') {
                checkProximityWarnings(userLatLng);
            }
        }

        function updateGPSAccuracy(accuracy) {
            const accuracyDot = document.getElementById('accuracyDot');
            const accuracyText = document.getElementById('accuracyText');
            
            if (accuracy < 5) {
                accuracyDot.className = 'accuracy-dot good';
                accuracyText.textContent = 'GPS: Excellent';
            } else if (accuracy < 15) {
                accuracyDot.className = 'accuracy-dot medium';
                accuracyText.textContent = 'GPS: Good';
            } else {
                accuracyDot.className = 'accuracy-dot poor';
                accuracyText.textContent = 'GPS: Poor';
            }
        }

        function handleGeolocationError(error) {
            console.error('Geolocation error:', error);
            showNotification('Unable to get location', 'error');
        }

        function initializeDeviceOrientation() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    if (event.alpha !== null) {
                        deviceOrientation = event.alpha;
                        updateUserDirection();
                    }
                });
            }
        }

        function updateUserDirection() {
            const directionElement = document.getElementById('userDirection');
            if (directionElement) {
                directionElement.style.transform = `translateX(-50%) rotate(${deviceOrientation}deg)`;
            }
        }

        function populateUtilityPanel() {
            const utilityList = document.getElementById('utilityList');
            utilityList.innerHTML = '';

            Object.entries(utilityTypes).forEach(([key, utility]) => {
                const utilityDiv = document.createElement('div');
                utilityDiv.className = 'utility-type touchable';
                utilityDiv.innerHTML = `
                    <div class="utility-color" style="background: ${utility.color}"></div>
                    <span>${utility.icon} ${utility.name}</span>
                    <div class="utility-toggle active touchable" onclick="toggleUtility(event, '${key}')">
                        <div class="toggle-slider"></div>
                    </div>
                `;
                utilityDiv.onclick = (e) => {
                    if (!e.target.closest('.utility-toggle')) {
                        selectUtilityType(key);
                    }
                };
                utilityList.appendChild(utilityDiv);
            });
        }

        function selectUtilityType(type) {
            selectedUtilityType = type;
            document.querySelectorAll('.utility-type').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            if (drawingMode) {
                showNotification(`Drawing ${utilityTypes[type].name} ${selectedUtilityClass}`, 'info');
            }
        }

        function toggleUtility(event, type) {
            event.stopPropagation();
            const toggle = event.currentTarget;
            toggle.classList.toggle('active');
            
            // Toggle visibility of utilities of this type
            const isVisible = toggle.classList.contains('active');
            utilities.forEach(utility => {
                if (utility.type === type && utility.polyline) {
                    if (isVisible) {
                        utility.polyline.addTo(map);
                    } else {
                        map.removeLayer(utility.polyline);
                    }
                }
            });
        }

        function initializeStructures() {
            document.querySelectorAll('.structure-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const structureType = e.currentTarget.dataset.structure;
                    if (e.currentTarget.classList.contains('active')) {
                        e.currentTarget.classList.remove('active');
                        // Cancel structure placement
                    } else {
                        document.querySelectorAll('.structure-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        // Enable structure placement
                        enableStructurePlacement(structureType);
                    }
                });
            });
        }

        function enableStructurePlacement(type) {
            map.once('click', (e) => {
                placeStructure(type, e.latlng);
                document.querySelectorAll('.structure-btn').forEach(b => b.classList.remove('active'));
            });
        }

        function placeStructure(type, latlng) {
            const structure = structureTypes[type];
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'structure-marker',
                    html: structure.icon,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);

            structures.push({
                id: Date.now(),
                type,
                latlng,
                marker
            });

            showNotification(`${structure.name} placed`, 'success');
        }

        function initializeEventListeners() {
            // Drawing controls
            document.getElementById('drawBtn').addEventListener('click', toggleDrawingMode);
            document.getElementById('selectBtn').addEventListener('click', toggleSelectMode);
            document.getElementById('refineBtn').addEventListener('click', toggleRefineMode);
            document.getElementById('deleteBtn').addEventListener('click', toggleDeleteMode);

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
            
            // Map style buttons
            document.querySelectorAll('.map-style-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const style = e.target.dataset.style;
                    changeMapStyle(style);
                    document.querySelectorAll('.map-style-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Proximity range slider
            document.getElementById('proximityRange').addEventListener('input', (e) => {
                proximityDistance = parseInt(e.target.value);
                document.getElementById('proximityValue').textContent = proximityDistance;
            });

            // Prevent default touch behaviors
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent context menu
            document.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        function toggleDrawingMode() {
            drawingMode = !drawingMode;
            document.getElementById('drawBtn').classList.toggle('active', drawingMode);
            
            if (drawingMode) {
                currentDrawing = [];
                showNotification(`Drawing ${utilityTypes[selectedUtilityType].name} ${selectedUtilityClass}`, 'info');
                map.getContainer().style.cursor = 'crosshair';
            } else {
                finishDrawing();
                map.getContainer().style.cursor = '';
            }
        }

        function toggleSelectMode() {
            // Implementation for select mode
            document.getElementById('selectBtn').classList.toggle('active');
        }

        function toggleRefineMode() {
            refineMode = !refineMode;
            document.getElementById('refineBtn').classList.toggle('active', refineMode);
            
            if (refineMode && selectedUtility) {
                showRefinePoints(selectedUtility);
            } else {
                hideRefinePoints();
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            document.getElementById('deleteBtn').classList.toggle('active', deleteMode);
            
            if (deleteMode) {
                showNotification('Select utility to delete', 'info');
                map.getContainer().style.cursor = 'not-allowed';
            } else {
                map.getContainer().style.cursor = '';
            }
        }

        function handleMapClick(e) {
            if (drawingMode) {
                addPointToDrawing(e.latlng);
            } else if (deleteMode) {
                // Check if click is on a utility
                const clickPoint = map.latLngToContainerPoint(e.latlng);
                utilities.forEach(utility => {
                    if (utility.polyline) {
                        const polylineElement = utility.polyline._path;
                        const rect = polylineElement.getBoundingClientRect();
                        // Simple proximity check - could be improved
                        if (isPointNearPolyline(clickPoint, utility.points)) {
                            deleteUtility(utility);
                        }
                    }
                });
            }
        }

        function addPointToDrawing(latlng) {
            currentDrawing.push(latlng);
            
            if (currentDrawing.length === 1) {
                // First point - create marker
                L.circleMarker(latlng, {
                    radius: 6,
                    color: utilityTypes[selectedUtilityType].color,
                    fillColor: utilityTypes[selectedUtilityType].color,
                    fillOpacity: 0.8
                }).addTo(map);
            } else {
                // Draw line segment
                if (currentDrawing.length === 2) {
                    // Create initial polyline
                    const polyline = L.polyline(currentDrawing, {
                        color: utilityTypes[selectedUtilityType].color,
                        weight: 4,
                        opacity: 0.8,
                        className: `utility-line ${selectedUtilityType} ${selectedUtilityClass}`
                    }).addTo(map);
                    
                    // Store reference for updating
                    currentDrawing.polyline = polyline;
                } else {
                    // Update existing polyline
                    currentDrawing.polyline.setLatLngs(currentDrawing);
                }
                
                // Check for auto-connect
                if (autoConnect) {
                    checkAutoConnect(latlng);
                }
            }
        }

        function checkAutoConnect(newPoint) {
            const threshold = 0.00005; // Approximately 5 meters
            
            utilities.forEach(utility => {
                if (utility.type === selectedUtilityType) {
                    // Check start and end points
                    const startPoint = utility.points[0];
                    const endPoint = utility.points[utility.points.length - 1];
                    
                    if (getDistance(newPoint, startPoint) < threshold || 
                        getDistance(newPoint, endPoint) < threshold) {
                        showConnectionDialog(utility, newPoint);
                    }
                }
            });
        }

        function getDistance(point1, point2) {
            const lat1 = point1.lat || point1[0];
            const lng1 = point1.lng || point1[1];
            const lat2 = point2.lat || point2[0];
            const lng2 = point2.lng || point2[1];
            
            return Math.sqrt(Math.pow(lat2 - lat1, 2) + Math.pow(lng2 - lng1, 2));
        }

        function showConnectionDialog(utility, point) {
            const dialog = document.createElement('div');
            dialog.className = 'connection-dialog';
            dialog.style.left = '50%';
            dialog.style.top = '50%';
            dialog.style.transform = 'translate(-50%, -50%)';
            dialog.innerHTML = `
                <h4>Connect to existing ${utilityTypes[utility.type].name}?</h4>
                <div class="connection-actions">
                    <button class="btn btn-secondary touchable" onclick="closeConnectionDialog()">No</button>
                    <button class="btn btn-primary touchable" onclick="connectUtilities(${utility.id})">Yes</button>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function closeConnectionDialog() {
            document.querySelector('.connection-dialog')?.remove();
        }

        function connectUtilities(utilityId) {
            closeConnectionDialog();
            // Implementation for connecting utilities
            showNotification('Utilities connected', 'success');
        }

        function finishDrawing() {
            if (currentDrawing.length > 1) {
                const utility = {
                    id: Date.now(),
                    type: selectedUtilityType,
                    class: selectedUtilityClass,
                    points: currentDrawing.map(p => [p.lat, p.lng]),
                    polyline: currentDrawing.polyline,
                    info: {
                        depth: null,
                        size: null,
                        material: null,
                        condition: null,
                        image: null
                    }
                };
                
                utilities.push(utility);
                showModal(utility);
            }
            
            currentDrawing = [];
        }

        function handleLongPress(e) {
            if (currentMode === 'mapping' && !drawingMode) {
                const clickPoint = map.latLngToContainerPoint(e.latlng);
                
                utilities.forEach(utility => {
                    if (isPointNearPolyline(clickPoint, utility.points)) {
                        selectedUtility = utility;
                        showUtilityInfo(utility);
                    }
                });
            }
        }

        function isPointNearPolyline(point, polylinePoints) {
            // Simple proximity check - could be improved with proper line-to-point distance calculation
            const threshold = 20; // pixels
            
            for (let i = 0; i < polylinePoints.length - 1; i++) {
                const p1 = map.latLngToContainerPoint(polylinePoints[i]);
                const p2 = map.latLngToContainerPoint(polylinePoints[i + 1]);
                
                const dist = pointToLineDistance(point, p1, p2);
                if (dist < threshold) {
                    return true;
                }
            }
            
            return false;
        }

        function pointToLineDistance(point, lineStart, lineEnd) {
            const A = point.x - lineStart.x;
            const B = point.y - lineStart.y;
            const C = lineEnd.x - lineStart.x;
            const D = lineEnd.y - lineStart.y;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = lineStart.x;
                yy = lineStart.y;
            } else if (param > 1) {
                xx = lineEnd.x;
                yy = lineEnd.y;
            } else {
                xx = lineStart.x + param * C;
                yy = lineStart.y + param * D;
            }
            
            const dx = point.x - xx;
            const dy = point.y - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        function showUtilityInfo(utility) {
            const popup = L.popup()
                .setLatLng(utility.points[Math.floor(utility.points.length / 2)])
                .setContent(createUtilityInfoContent(utility))
                .openOn(map);
        }

        function createUtilityInfoContent(utility) {
            const info = utility.info;
            const utilityConfig = utilityTypes[utility.type];
            
            return `
                <div class="utility-info-popup">
                    <div class="info-title">
                        <span>${utilityConfig.icon}</span>
                        <span>${utilityConfig.name} ${utility.class}</span>
                    </div>
                    <div class="info-details">
                        ${info.depth ? `<div class="info-row"><span>Depth:</span><span>${info.depth} ft</span></div>` : ''}
                        ${info.size ? `<div class="info-row"><span>Size:</span><span>${info.size}"</span></div>` : ''}
                        ${info.material ? `<div class="info-row"><span>Material:</span><span>${info.material}</span></div>` : ''}
                        ${info.condition ? `<div class="info-row"><span>Condition:</span><span>${info.condition}</span></div>` : ''}
                    </div>
                    <div class="info-actions">
                        <button class="btn btn-secondary touchable" onclick="editUtility(${utility.id})">Edit</button>
                        <button class="btn btn-secondary touchable" onclick="refineUtility(${utility.id})">Refine</button>
                    </div>
                </div>
            `;
        }

        function editUtility(id) {
            const utility = utilities.find(u => u.id === id);
            if (utility) {
                map.closePopup();
                showModal(utility);
            }
        }

        function refineUtility(id) {
            const utility = utilities.find(u => u.id === id);
            if (utility) {
                map.closePopup();
                selectedUtility = utility;
                toggleRefineMode();
            }
        }

        function showRefinePoints(utility) {
            hideRefinePoints();
            
            utility.refineMarkers = [];
            
            utility.points.forEach((point, index) => {
                const marker = L.marker(point, {
                    icon: L.divIcon({
                        className: 'refine-point',
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    }),
                    draggable: true
                }).addTo(map);
                
                marker.on('drag', (e) => {
                    utility.points[index] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
                    utility.polyline.setLatLngs(utility.points);
                });
                
                utility.refineMarkers.push(marker);
            });
        }

        function hideRefinePoints() {
            utilities.forEach(utility => {
                if (utility.refineMarkers) {
                    utility.refineMarkers.forEach(marker => map.removeLayer(marker));
                    utility.refineMarkers = [];
                }
            });
        }

        function deleteUtility(utility) {
            if (confirm(`Delete this ${utilityTypes[utility.type].name} ${utility.class}?`)) {
                // Remove from map
                if (utility.polyline) {
                    map.removeLayer(utility.polyline);
                }
                
                // Remove from array
                const index = utilities.findIndex(u => u.id === utility.id);
                if (index > -1) {
                    utilities.splice(index, 1);
                }
                
                showNotification('Utility deleted', 'success');
                saveData();
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            if (mode === 'mapping') {
                modeIcon.className = 'mode-icon mapping';
                modeIcon.textContent = 'üó∫Ô∏è';
                modeText.textContent = 'Mapping Mode';
                document.getElementById('drawingControls').classList.remove('hidden');
                clearProximityWarnings();
            } else {
                modeIcon.className = 'mode-icon excavation';
                modeIcon.textContent = 'üöß';
                modeText.textContent = 'Excavation Mode';
                document.getElementById('drawingControls').classList.add('hidden');
                
                // Zoom to user location
                if (userLocationMarker) {
                    map.setView(userLocationMarker.getLatLng(), 19);
                }
            }
        }

        function checkProximityWarnings(userLatLng) {
            utilities.forEach(utility => {
                const distance = getClosestDistanceToUtility(userLatLng, utility);
                const warningId = `warning-${utility.id}`;
                
                if (distance <= proximityDistance / 3280.84) { // Convert feet to degrees (approximate)
                    if (!proximityWarnings.has(warningId) && !warningCooldowns.has(warningId)) {
                        createProximityWarning(utility, Math.round(distance * 3280.84));
                    }
                } else {
                    if (proximityWarnings.has(warningId)) {
                        const warning = proximityWarnings.get(warningId);
                        if (!warning.manualClose) {
                            // Start 45 second timer
                            if (!warning.exitTimer) {
                                warning.exitTimer = setTimeout(() => {
                                    removeProximityWarning(warningId);
                                }, 45000);
                            }
                        }
                    }
                }
            });
        }

        function getClosestDistanceToUtility(point, utility) {
            let minDistance = Infinity;
            
            for (let i = 0; i < utility.points.length - 1; i++) {
                const segmentDistance = pointToSegmentDistance(
                    point,
                    utility.points[i],
                    utility.points[i + 1]
                );
                minDistance = Math.min(minDistance, segmentDistance);
            }
            
            return minDistance;
        }

        function pointToSegmentDistance(point, segStart, segEnd) {
            const A = point.lat - segStart[0];
            const B = point.lng - segStart[1];
            const C = segEnd[0] - segStart[0];
            const D = segEnd[1] - segStart[1];
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = segStart[0];
                yy = segStart[1];
            } else if (param > 1) {
                xx = segEnd[0];
                yy = segEnd[1];
            } else {
                xx = segStart[0] + param * C;
                yy = segStart[1] + param * D;
            }
            
            const dx = point.lat - xx;
            const dy = point.lng - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        function createProximityWarning(utility, distance) {
            const warningId = `warning-${utility.id}`;
            const warningsContainer = document.getElementById('proximityWarnings');
            
            // Check if we already have 5 warnings
            if (warningsContainer.children.length >= 5) {
                return;
            }
            
            const warningBox = document.createElement('div');
            warningBox.className = 'warning-box';
            warningBox.id = warningId;
            warningBox.innerHTML = `
                <div class="warning-header">
                    <div class="warning-title">
                        <div class="warning-icon">‚ö†Ô∏è</div>
                        <span>${utilityTypes[utility.type].name} ${utility.class}</span>
                    </div>
                    <button class="close-warning touchable" onclick="closeWarning('${warningId}')">√ó</button>
                </div>
                <div class="warning-details">
                    <div class="warning-detail">
                        <span>Distance:</span>
                        <span>${distance} ft</span>
                    </div>
                    ${utility.info.depth ? `<div class="warning-detail"><span>Depth:</span><span>${utility.info.depth} ft</span></div>` : ''}
                    ${utility.info.size ? `<div class="warning-detail"><span>Size:</span><span>${utility.info.size}"</span></div>` : ''}
                    ${utility.info.material ? `<div class="warning-detail"><span>Material:</span><span>${utility.info.material}</span></div>` : ''}
                </div>
            `;
            
            warningsContainer.appendChild(warningBox);
            
            proximityWarnings.set(warningId, {
                utility,
                element: warningBox,
                manualClose: false,
                exitTimer: null
            });
            
            // Highlight utility on map
            if (utility.polyline) {
                utility.polyline.setStyle({ weight: 8, opacity: 1 });
            }
        }

        function closeWarning(warningId) {
            const warning = proximityWarnings.get(warningId);
            if (warning) {
                warning.manualClose = true;
                removeProximityWarning(warningId);
                
                // Set 3 minute cooldown
                warningCooldowns.set(warningId, true);
                setTimeout(() => {
                    warningCooldowns.delete(warningId);
                }, 180000);
            }
        }

        function removeProximityWarning(warningId) {
            const warning = proximityWarnings.get(warningId);
            if (warning) {
                warning.element.remove();
                proximityWarnings.delete(warningId);
                
                // Reset utility style
                if (warning.utility.polyline) {
                    warning.utility.polyline.setStyle({ weight: 4, opacity: 0.8 });
                }
            }
        }

        function clearProximityWarnings() {
            proximityWarnings.forEach((warning, id) => {
                removeProximityWarning(id);
            });
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.toggle('hidden');
        }

        function setUtilityType(type) {
            selectedUtilityClass = type;
            document.getElementById('mainType').classList.toggle('active', type === 'main');
            document.getElementById('serviceType').classList.toggle('active', type === 'service');
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const toggle = document.getElementById('darkModeToggle');
            toggle.classList.toggle('active');
            
            const icon = document.getElementById('darkModeIcon');
            icon.textContent = toggle.classList.contains('active') ? 'üåô' : '‚òÄÔ∏è';
            
            // Save preference
            localStorage.setItem('darkMode', toggle.classList.contains('active'));
        }

        function toggleGPSAccuracy(toggle) {
            toggle.classList.toggle('active');
            highAccuracyGPS = toggle.classList.contains('active');
            
            // Restart geolocation with new settings
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                initializeGeolocation();
            }
        }

        function toggleAutoConnect(toggle) {
            toggle.classList.toggle('active');
            autoConnect = toggle.classList.contains('active');
        }

        function changeMapStyle(style) {
            // Clear existing layers
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            // Add new layer based on style
            switch (style) {
                case 'satellite':
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
                    break;
                case 'hybrid':
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
                    L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-hybrid/{z}/{x}/{y}.png').addTo(map);
                    break;
                default:
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
        }

        function showModal(utility) {
            const modal = document.getElementById('modalOverlay');
            modal.classList.add('active');
            
            // Populate form with existing data
            document.getElementById('utilityDepth').value = utility.info.depth || '';
            document.getElementById('utilitySize').value = utility.info.size || '';
            document.getElementById('utilityMaterial').value = utility.info.material || '';
            document.getElementById('utilityCondition').value = utility.info.condition || '';
            
            // Store current utility ID
            modal.dataset.utilityId = utility.id;
            
            // Reset image preview
            document.getElementById('imagePlaceholder').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
            
            if (utility.info.image) {
                document.getElementById('imagePreview').src = utility.info.image;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imagePlaceholder').style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function saveUtilityInfo() {
            const modal = document.getElementById('modalOverlay');
            const utilityId = parseInt(modal.dataset.utilityId);
            const utility = utilities.find(u => u.id === utilityId);
            
            if (utility) {
                utility.info = {
                    depth: document.getElementById('utilityDepth').value,
                    size: document.getElementById('utilitySize').value,
                    material: document.getElementById('utilityMaterial').value,
                    condition: document.getElementById('utilityCondition').value,
                    image: document.getElementById('imagePreview').src !== '' ? 
                           document.getElementById('imagePreview').src : null
                };
                
                saveData();
                showNotification('Utility information saved', 'success');
                closeModal();
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imagePlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            
            notification.className = `notification ${type}`;
            text.textContent = message;
            
            switch (type) {
                case 'success':
                    icon.textContent = '‚úÖ';
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    break;
                default:
                    icon.textContent = '‚ÑπÔ∏è';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function saveData() {
            const data = {
                utilities: utilities.map(u => ({
                    id: u.id,
                    type: u.type,
                    class: u.class,
                    points: u.points,
                    info: u.info
                })),
                structures: structures.map(s => ({
                    id: s.id,
                    type: s.type,
                    latlng: s.latlng
                }))
            };
            
            localStorage.setItem('cacUtiliTrackData', JSON.stringify(data));
        }

        function loadSavedData() {
            const saved = localStorage.getItem('cacUtiliTrackData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Load utilities
                    data.utilities?.forEach(utilityData => {
                        const polyline = L.polyline(utilityData.points, {
                            color: utilityTypes[utilityData.type].color,
                            weight: 4,
                            opacity: 0.8,
                            className: `utility-line ${utilityData.type} ${utilityData.class}`
                        }).addTo(map);
                        
                        utilities.push({
                            ...utilityData,
                            polyline
                        });
                    });
                    
                    // Load structures
                    data.structures?.forEach(structureData => {
                        placeStructure(structureData.type, structureData.latlng);
                    });
                    
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }

        // Prevent pinch zoom
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        document.addEventListener('gesturechange', (e) => e.preventDefault());
        document.addEventListener('gestureend', (e) => e.preventDefault());
    </script>
</body>
</html>
