<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CAC Utili-Track - Precision Utility Mapping</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <style>
        /*********************************
        * CSS RESET & VARIABLES
        *********************************/
        :root {
            /* Utility Colors */
            --water-color: #2196F3;
            --gas-color: #FFD600;
            --electric-color: #F44336;
            --sewer-color: #795548;
            --telecom-color: #9C27B0;
            
            /* Light Theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F5;
            --bg-tertiary: #E8E8E8;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-tertiary: #9E9E9E;
            --border-color: rgba(0,0,0,0.12);
            --shadow-color: rgba(0,0,0,0.1);
            
            /* UI Colors */
            --primary: #1976D2;
            --primary-dark: #0D47A1;
            --primary-light: #42A5F5;
            --accent: #FF5252;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --info: #2196F3;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index layers */
            --z-map: 1;
            --z-controls: 100;
            --z-fab: 200;
            --z-modal: 300;
            --z-toast: 400;
            --z-splash: 500;
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --bg-tertiary: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-tertiary: #808080;
            --border-color: rgba(255,255,255,0.12);
            --shadow-color: rgba(0,0,0,0.5);
            
            --primary: #42A5F5;
            --primary-dark: #1976D2;
            --primary-light: #64B5F6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            touch-action: none;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        /*********************************
        * SPLASH SCREEN
        *********************************/
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-splash);
            transition: opacity 0.5s ease-out;
        }
        
        .splash-logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: var(--spacing-xl);
        }
        
        .splash-logo {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .construction-icon {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        .construction-icon:nth-child(1) {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            animation-delay: 0s;
        }
        
        .construction-icon:nth-child(2) {
            top: 25%;
            right: 0;
            animation-delay: 0.5s;
        }
        
        .construction-icon:nth-child(3) {
            bottom: 0;
            right: 20%;
            animation-delay: 1s;
        }
        
        .construction-icon:nth-child(4) {
            bottom: 0;
            left: 20%;
            animation-delay: 1.5s;
        }
        
        .construction-icon:nth-child(5) {
            top: 25%;
            left: 0;
            animation-delay: 2s;
        }
        
        .splash-center-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #1976D2;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: centerPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% {
                transform: translateX(-50%) translateY(0) scale(1);
            }
            50% {
                transform: translateX(-50%) translateY(-10px) scale(1.1);
            }
        }
        
        @keyframes centerPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            }
        }
        
        .splash-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: var(--spacing-sm);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.5s forwards;
        }
        
        .splash-subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.7s forwards;
        }
        
        .splash-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: var(--spacing-xl);
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 1s forwards;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: progressLoad 2s ease-out 1.2s forwards;
            transform: scaleX(0);
            transform-origin: left;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
            from {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        @keyframes progressLoad {
            to { transform: scaleX(1); }
        }
        
        /*********************************
        * APP CONTAINER
        *********************************/
        .app-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        .app-container.visible {
            opacity: 1;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: var(--z-map);
        }
        
        /*********************************
        * HEADER
        *********************************/
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            z-index: var(--z-controls);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.9);
            padding-top: env(safe-area-inset-top);
        }
        
        [data-theme="dark"] .app-header {
            background: rgba(18,18,18, 0.95);
        }
        
        .header-title {
            flex: 1;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 18px;
        }
        
        .header-btn:active {
            transform: scale(0.95);
            background: var(--bg-tertiary);
        }
        
        /*********************************
        * UTILITY SELECTOR
        *********************************/
        .utility-selector {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top) + var(--spacing-md));
            left: var(--spacing-md);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-xs);
            z-index: var(--z-controls);
            display: flex;
            gap: var(--spacing-xs);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .utility-selector {
            background: rgba(30,30,30, 0.95);
        }
        
        .utility-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .utility-btn:active {
            transform: scale(0.95);
        }
        
        .utility-btn.active {
            background: var(--bg-secondary);
        }
        
        .utility-btn.active::before {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .utility-icon {
            font-size: 20px;
            transition: transform var(--transition-fast);
        }
        
        .utility-btn:hover .utility-icon {
            transform: scale(1.1);
        }
        
        .utility-btn.water { color: var(--water-color); }
        .utility-btn.gas { color: var(--gas-color); }
        .utility-btn.electric { color: var(--electric-color); }
        .utility-btn.sewer { color: var(--sewer-color); }
        .utility-btn.telecom { color: var(--telecom-color); }
        
        /*********************************
        * LINE TYPE TOGGLE
        *********************************/
        .line-type-toggle {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top) + var(--spacing-md));
            right: var(--spacing-md);
            background: var(--bg-primary);
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-xs);
            z-index: var(--z-controls);
            display: flex;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .line-type-toggle {
            background: rgba(30,30,30, 0.95);
        }
        
        .line-type-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-full);
            white-space: nowrap;
        }
        
        .line-type-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /*********************************
        * MAP CONTROLS
        *********************************/
        .map-controls {
            position: fixed;
            bottom: calc(100px + env(safe-area-inset-bottom));
            right: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            z-index: var(--z-controls);
        }
        
        .map-control-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--bg-primary);
            border: none;
            box-shadow: 0 4px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .map-control-btn {
            background: rgba(30,30,30, 0.95);
        }
        
        .map-control-btn:active {
            transform: scale(0.95);
        }
        
        .location-btn.tracking {
            color: var(--primary);
        }
        
        /*********************************
        * FLOATING ACTION BUTTONS
        *********************************/
        .fab-container {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
            right: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--spacing-md);
            z-index: var(--z-fab);
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-size: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .fab-primary {
            background: var(--primary);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }
        
        .fab-danger {
            background: var(--danger);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
            transform: scale(0);
            opacity: 0;
        }
        
        .fab-danger.visible {
            transform: scale(1);
            opacity: 1;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .excavation-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(transparent 0deg, white var(--progress), transparent var(--progress));
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .excavation-progress.active {
            opacity: 1;
        }
        
        /*********************************
        * USER LOCATION MARKER
        *********************************/
        .user-location-marker {
            width: 40px;
            height: 40px;
            position: relative;
        }
        
        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.3);
            transform: translate(-50%, -50%);
            animation: pulse 2s ease-out infinite;
        }
        
        .location-pulse:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .location-pulse:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }
        
        .location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            background: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 3;
        }
        
        .location-arrow {
            position: absolute;
            top: -8px;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 16px solid #2196F3;
            transform: translateX(-50%) rotate(var(--heading, 0deg));
            transform-origin: center bottom;
            transition: transform 0.3s ease-out;
            z-index: 2;
        }
        
        /*********************************
        * UTILITY DRAWING
        *********************************/
        .drawing-controls {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-sm);
            display: flex;
            gap: var(--spacing-sm);
            z-index: var(--z-controls);
            opacity: 0;
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .drawing-controls {
            background: rgba(30,30,30, 0.95);
        }
        
        .drawing-controls.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .drawing-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .drawing-btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .drawing-btn-finish {
            background: var(--success);
            color: white;
        }
        
        .drawing-btn:active {
            transform: scale(0.95);
        }
        
        /*********************************
        * UTILITY INFO POPUP
        *********************************/
        .utility-info-popup {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
            left: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-lg);
            z-index: var(--z-modal);
            transform: translateY(200%);
            opacity: 0;
            transition: all var(--transition-normal);
            max-height: 50vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .utility-info-popup {
            background: rgba(30,30,30, 0.95);
        }
        
        .utility-info-popup.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .popup-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .popup-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .popup-close:active {
            transform: scale(0.9);
        }
        
        .popup-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .popup-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .popup-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .popup-btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .popup-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .popup-btn:active {
            transform: scale(0.95);
        }
        
        /*********************************
        * MODAL
        *********************************/
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }
        
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: calc(100% - var(--spacing-xl) * 2);
            max-width: 400px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 40px var(--shadow-color);
            padding: var(--spacing-lg);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-backdrop.visible .modal {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            transition: all var(--transition-fast);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }
        
        .form-btn {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .form-btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .form-btn-submit {
            background: var(--primary);
            color: white;
        }
        
        .form-btn:active {
            transform: scale(0.95);
        }
        
        /*********************************
        * EXCAVATION MODE
        *********************************/
        .excavation-indicator {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top) + var(--spacing-md));
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
            z-index: var(--z-controls);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            animation: excavationPulse 2s ease-in-out infinite;
        }
        
        .excavation-indicator.visible {
            opacity: 1;
            visibility: visible;
        }
        
        @keyframes excavationPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        .proximity-alerts {
            position: fixed;
            top: calc(120px + env(safe-area-inset-top));
            left: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            z-index: var(--z-controls);
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .proximity-alert {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-md);
            transform: translateX(-100%);
            opacity: 0;
            transition: all var(--transition-normal);
            border-left: 4px solid var(--danger);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .proximity-alert {
            background: rgba(30,30,30, 0.95);
        }
        
        .proximity-alert.visible {
            transform: translateX(0);
            opacity: 1;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .alert-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .alert-close {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }
        
        .alert-close:active {
            transform: scale(0.9);
            background: var(--bg-secondary);
        }
        
        .alert-content {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .alert-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .alert-distance {
            font-size: 18px;
            font-weight: 600;
            color: var(--danger);
            margin-top: var(--spacing-sm);
        }
        
        /*********************************
        * SETTINGS MENU
        *********************************/
        .settings-menu {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            right: 0;
            width: 300px;
            max-width: 80vw;
            height: calc(100% - 60px - env(safe-area-inset-top));
            background: var(--bg-primary);
            box-shadow: -4px 0 20px var(--shadow-color);
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            z-index: var(--z-modal);
            overflow-y: auto;
            padding: var(--spacing-lg);
        }
        
        .settings-menu.visible {
            transform: translateX(0);
        }
        
        .settings-section {
            margin-bottom: var(--spacing-xl);
        }
        
        .settings-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: var(--spacing-md);
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .toggle-switch {
            width: 48px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            position: relative;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .toggle-switch.active {
            background: var(--primary);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        .map-style-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .map-style-option {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-secondary);
        }
        
        .map-style-option.active {
            border-color: var(--primary);
            background: var(--bg-primary);
        }
        
        .map-style-option i {
            font-size: 24px;
            color: var(--primary);
            display: block;
            margin-bottom: var(--spacing-xs);
        }
        
        .map-style-option span {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /*********************************
        * CONNECTION INDICATOR
        *********************************/
        .connection-indicator {
            position: absolute;
            background: var(--primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            z-index: var(--z-controls);
            opacity: 0;
            transform: scale(0.8);
            transition: all var(--transition-fast);
        }
        
        .connection-indicator.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        /*********************************
        * REFINE LOCATION CONTROLS
        *********************************/
        .refine-controls {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px var(--shadow-color);
            padding: var(--spacing-md);
            z-index: var(--z-controls);
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(100px);
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .refine-controls {
            background: rgba(30,30,30, 0.95);
        }
        
        .refine-controls.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .refine-point {
            width: 16px;
            height: 16px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform var(--transition-fast);
        }
        
        .refine-point:active {
            transform: scale(1.2);
        }
        
        /*********************************
        * TOAST NOTIFICATIONS
        *********************************/
        .toast {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px var(--shadow-color);
            font-size: 14px;
            font-weight: 500;
            z-index: var(--z-toast);
            opacity: 0;
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
        }
        
        [data-theme="dark"] .toast {
            background: rgba(30,30,30, 0.95);
        }
        
        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /*********************************
        * UTILITY STYLES
        *********************************/
        .utility-line {
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            cursor: pointer;
            transition: stroke-width var(--transition-fast);
        }
        
        .utility-line:hover {
            stroke-width: 6;
        }
        
        .utility-line.main {
            stroke-width: 6;
        }
        
        .utility-line.main:hover {
            stroke-width: 8;
        }
        
        .utility-line.service {
            stroke-dasharray: 8, 8;
        }
        
        .utility-line.water { stroke: var(--water-color); }
        .utility-line.gas { stroke: var(--gas-color); }
        .utility-line.electric { stroke: var(--electric-color); }
        .utility-line.sewer { stroke: var(--sewer-color); }
        .utility-line.telecom { stroke: var(--telecom-color); }
        
        .utility-line.highlight {
            stroke-width: 8;
            filter: drop-shadow(0 0 4px currentColor);
        }
        
        /*********************************
        * RESPONSIVE
        *********************************/
        @media (max-width: 375px) {
            .utility-selector {
                left: var(--spacing-sm);
                padding: 2px;
            }
            
            .utility-btn {
                width: 40px;
                height: 40px;
            }
            
            .line-type-toggle {
                right: var(--spacing-sm);
            }
            
            .line-type-btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 12px;
            }
        }
        
        /*********************************
        * LEAFLET OVERRIDES
        *********************************/
        .leaflet-container {
            background: var(--bg-secondary);
            font-family: inherit;
        }
        
        .leaflet-control-attribution {
            display: none;
        }
        
        .leaflet-control-zoom {
            display: none;
        }
        
        .leaflet-popup-content-wrapper {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        
        .leaflet-popup-tip {
            background: var(--bg-primary);
        }
        
        /*********************************
        * ANIMATIONS
        *********************************/
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /*********************************
        * UTILITY CLASSES
        *********************************/
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .invisible {
            opacity: 0 !important;
            visibility: hidden !important;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo-container">
            <div class="splash-logo">
                <div class="construction-icon" style="color: var(--water-color)">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="construction-icon" style="color: var(--gas-color)">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="construction-icon" style="color: var(--electric-color)">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="construction-icon" style="color: var(--sewer-color)">
                    <i class="fas fa-toilet"></i>
                </div>
                <div class="construction-icon" style="color: var(--telecom-color)">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="splash-center-logo">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
            </div>
        </div>
        <h1 class="splash-title">CAC Utili-Track</h1>
        <p class="splash-subtitle">Precision Utility Mapping</p>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <h1 class="header-title">CAC Utili-Track</h1>
            <div class="header-actions">
                <button class="header-btn" id="themeToggle" aria-label="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="header-btn" id="settingsBtn" aria-label="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- Map -->
        <div id="map"></div>

        <!-- Utility Selector -->
        <div class="utility-selector">
            <button class="utility-btn water active" data-utility="water" aria-label="Water utility">
                <i class="fas fa-tint utility-icon"></i>
            </button>
            <button class="utility-btn gas" data-utility="gas" aria-label="Gas utility">
                <i class="fas fa-fire utility-icon"></i>
            </button>
            <button class="utility-btn electric" data-utility="electric" aria-label="Electric utility">
                <i class="fas fa-bolt utility-icon"></i>
            </button>
            <button class="utility-btn sewer" data-utility="sewer" aria-label="Sewer utility">
                <i class="fas fa-toilet utility-icon"></i>
            </button>
            <button class="utility-btn telecom" data-utility="telecom" aria-label="Telecom utility">
                <i class="fas fa-phone utility-icon"></i>
            </button>
        </div>

        <!-- Line Type Toggle -->
        <div class="line-type-toggle">
            <button class="line-type-btn active" data-type="service">Service</button>
            <button class="line-type-btn" data-type="main">Main</button>
        </div>

        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="zoomInBtn" aria-label="Zoom in">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" aria-label="Zoom out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn location-btn" id="locationBtn" aria-label="My location">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>

        <!-- Floating Action Buttons -->
        <div class="fab-container">
            <button class="fab fab-danger" id="excavationBtn" aria-label="Excavation mode">
                <i class="fas fa-hard-hat"></i>
                <div class="excavation-progress"></div>
            </button>
            <button class="fab fab-primary" id="drawBtn" aria-label="Draw utility">
                <i class="fas fa-pencil-alt"></i>
            </button>
        </div>

        <!-- Drawing Controls -->
        <div class="drawing-controls" id="drawingControls">
            <button class="drawing-btn drawing-btn-cancel" id="cancelDrawingBtn">Cancel</button>
            <button class="drawing-btn drawing-btn-finish" id="finishDrawingBtn">Finish</button>
        </div>

        <!-- Utility Info Popup -->
        <div class="utility-info-popup" id="utilityInfoPopup">
            <div class="popup-header">
                <div class="popup-title">
                    <i class="fas fa-tint" id="popupIcon"></i>
                    <span id="popupTitle">Water Service Line</span>
                </div>
                <button class="popup-close" id="popupClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-content" id="popupContent">
                <!-- Content will be dynamically added -->
            </div>
            <div class="popup-actions">
                <button class="popup-btn popup-btn-secondary" id="editUtilityBtn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="popup-btn popup-btn-primary" id="refineLocationBtn">
                    <i class="fas fa-crosshairs"></i> Refine Location
                </button>
            </div>
        </div>

        <!-- Excavation Mode Indicator -->
        <div class="excavation-indicator" id="excavationIndicator">
            <i class="fas fa-exclamation-triangle"></i> EXCAVATION MODE ACTIVE
        </div>

        <!-- Proximity Alerts Container -->
        <div class="proximity-alerts" id="proximityAlerts"></div>

        <!-- Refine Location Controls -->
        <div class="refine-controls" id="refineControls">
            <h3 style="font-size: 16px; margin-bottom: var(--spacing-md);">Drag points to refine location</h3>
            <div class="form-actions">
                <button class="form-btn form-btn-cancel" id="cancelRefineBtn">Cancel</button>
                <button class="form-btn form-btn-submit" id="saveRefineBtn">Save</button>
            </div>
        </div>

        <!-- Settings Menu -->
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-section">
                <h3 class="settings-title">Visibility</h3>
                <div class="settings-item">
                    <label class="settings-label">
                        <i class="fas fa-tint" style="color: var(--water-color)"></i> Water
                    </label>
                    <div class="toggle-switch active" data-utility="water"></div>
                </div>
                <div class="settings-item">
                    <label class="settings-label">
                        <i class="fas fa-fire" style="color: var(--gas-color)"></i> Gas
                    </label>
                    <div class="toggle-switch active" data-utility="gas"></div>
                </div>
                <div class="settings-item">
                    <label class="settings-label">
                        <i class="fas fa-bolt" style="color: var(--electric-color)"></i> Electric
                    </label>
                    <div class="toggle-switch active" data-utility="electric"></div>
                </div>
                <div class="settings-item">
                    <label class="settings-label">
                        <i class="fas fa-toilet" style="color: var(--sewer-color)"></i> Sewer
                    </label>
                    <div class="toggle-switch active" data-utility="sewer"></div>
                </div>
                <div class="settings-item">
                    <label class="settings-label">
                        <i class="fas fa-phone" style="color: var(--telecom-color)"></i> Telecom
                    </label>
                    <div class="toggle-switch active" data-utility="telecom"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Line Types</h3>
                <div class="settings-item">
                    <label class="settings-label">Service Lines</label>
                    <div class="toggle-switch active" data-linetype="service"></div>
                </div>
                <div class="settings-item">
                    <label class="settings-label">Main Lines</label>
                    <div class="toggle-switch active" data-linetype="main"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Map Style</h3>
                <div class="map-style-selector">
                    <div class="map-style-option active" data-style="streets">
                        <i class="fas fa-map"></i>
                        <span>Streets</span>
                    </div>
                    <div class="map-style-option" data-style="satellite">
                        <i class="fas fa-globe"></i>
                        <span>Satellite</span>
                    </div>
                    <div class="map-style-option" data-style="terrain">
                        <i class="fas fa-mountain"></i>
                        <span>Terrain</span>
                    </div>
                    <div class="map-style-option" data-style="dark">
                        <i class="fas fa-moon"></i>
                        <span>Dark</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utility Info Modal -->
        <div class="modal-backdrop" id="utilityModal">
            <div class="modal">
                <h2 class="modal-title">Utility Information</h2>
                <form id="utilityForm">
                    <div class="form-group">
                        <label class="form-label" for="utilityDepth">Depth (feet)</label>
                        <input type="number" class="form-input" id="utilityDepth" step="0.5" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="utilitySize">Size (inches)</label>
                        <input type="number" class="form-input" id="utilitySize" step="0.5" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="utilityMaterial">Material</label>
                        <select class="form-input form-select" id="utilityMaterial" required>
                            <option value="">Select material</option>
                            <option value="PVC">PVC</option>
                            <option value="HDPE">HDPE</option>
                            <option value="Cast Iron">Cast Iron</option>
                            <option value="Copper">Copper</option>
                            <option value="Steel">Steel</option>
                            <option value="Concrete">Concrete</option>
                            <option value="Clay">Clay</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="utilityCondition">Condition</label>
                        <select class="form-input form-select" id="utilityCondition" required>
                            <option value="">Select condition</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="utilityDistance">Distance from Curb (feet)</label>
                        <input type="number" class="form-input" id="utilityDistance" step="0.5">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="utilityImage">Photo</label>
                        <input type="file" class="form-input" id="utilityImage" accept="image/*">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="form-btn form-btn-cancel" id="cancelUtilityBtn">Cancel</button>
                        <button type="submit" class="form-btn form-btn-submit">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Connection Indicator -->
        <div class="connection-indicator" id="connectionIndicator">
            <i class="fas fa-link"></i> Click to connect
        </div>

        <!-- Toast Container -->
        <div class="toast" id="toast"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        /*********************************
        * APP STATE & CONFIGURATION
        *********************************/
        const APP_CONFIG = {
            name: 'CAC Utili-Track',
            version: '2.0.0',
            excavationHoldTime: 2000, // 2 seconds
            proximityRadius: 15, // feet
            alertDismissTime: 45000, // 45 seconds
            alertCooldown: 180000, // 3 minutes
            mapCenter: [40.7128, -74.0060], // NYC default
            mapZoom: 18,
            utilityColors: {
                water: '#2196F3',
                gas: '#FFD600',
                electric: '#F44336',
                sewer: '#795548',
                telecom: '#9C27B0'
            },
            utilityIcons: {
                water: 'fa-tint',
                gas: 'fa-fire',
                electric: 'fa-bolt',
                sewer: 'fa-toilet',
                telecom: 'fa-phone'
            }
        };

        const AppState = {
            currentUtility: 'water',
            currentLineType: 'service',
            isDrawing: false,
            drawingPoints: [],
            isExcavationMode: false,
            isRefining: false,
            selectedUtility: null,
            utilities: [],
            dismissedAlerts: new Map(),
            visibilitySettings: {
                water: true,
                gas: true,
                electric: true,
                sewer: true,
                telecom: true,
                service: true,
                main: true
            },
            mapStyle: 'streets',
            theme: 'light',
            userLocation: null,
            userHeading: 0,
            locationWatchId: null,
            headingWatchId: null,
            tempLine: null,
            refinePoints: [],
            proximityCheckInterval: null,
            excavationHoldTimeout: null,
            excavationProgress: 0
        };

        /*********************************
        * MAP INITIALIZATION
        *********************************/
        let map;
        let userLocationMarker;
        let utilityLayers = {};
        let drawnItems;

        function initializeMap() {
            // Create map
            map = L.map('map', {
                center: APP_CONFIG.mapCenter,
                zoom: APP_CONFIG.mapZoom,
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            });

            // Add tile layer
            updateMapStyle('streets');

            // Create layer groups
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Initialize utility layers
            Object.keys(APP_CONFIG.utilityColors).forEach(type => {
                utilityLayers[type] = new L.FeatureGroup();
                map.addLayer(utilityLayers[type]);
            });

            // Map event listeners
            map.on('click', handleMapClick);
            map.on('contextmenu', (e) => e.originalEvent.preventDefault());

            // Start location tracking
            startLocationTracking();
        }

        /*********************************
        * MAP STYLES
        *********************************/
        const mapStyles = {
            streets: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                options: {
                    maxZoom: 22,
                    maxNativeZoom: 19
                }
            },
            satellite: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                options: {
                    maxZoom: 22,
                    maxNativeZoom: 19
                }
            },
            terrain: {
                url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png',
                options: {
                    maxZoom: 22,
                    maxNativeZoom: 18
                }
            },
            dark: {
                url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png',
                options: {
                    maxZoom: 22,
                    maxNativeZoom: 20
                }
            }
        };

        let currentTileLayer;

        function updateMapStyle(style) {
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }

            const mapStyle = mapStyles[style];
            currentTileLayer = L.tileLayer(mapStyle.url, mapStyle.options);
            currentTileLayer.addTo(map);
            AppState.mapStyle = style;
        }

        /*********************************
        * LOCATION TRACKING
        *********************************/
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    position => updateUserLocation(position),
                    error => console.error('Location error:', error),
                    { enableHighAccuracy: true }
                );

                // Watch position
                AppState.locationWatchId = navigator.geolocation.watchPosition(
                    position => updateUserLocation(position),
                    error => console.error('Location error:', error),
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );

                // Start heading tracking
                startHeadingTracking();
            }
        }

        function updateUserLocation(position) {
            const { latitude, longitude, accuracy } = position.coords;
            AppState.userLocation = [latitude, longitude];

            // Update or create marker
            if (userLocationMarker) {
                userLocationMarker.setLatLng(AppState.userLocation);
            } else {
                createUserLocationMarker();
            }

            // Update map view if first location
            if (!map.getBounds().contains(AppState.userLocation)) {
                map.setView(AppState.userLocation, APP_CONFIG.mapZoom);
            }

            // Check proximity if in excavation mode
            if (AppState.isExcavationMode) {
                checkProximityAlerts();
            }
        }

        function createUserLocationMarker() {
            const locationIcon = L.divIcon({
                className: 'user-location-marker',
                html: `
                    <div class="location-pulse"></div>
                    <div class="location-pulse"></div>
                    <div class="location-pulse"></div>
                    <div class="location-dot"></div>
                    <div class="location-arrow" style="--heading: ${AppState.userHeading}deg"></div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            userLocationMarker = L.marker(AppState.userLocation, {
                icon: locationIcon,
                zIndexOffset: 1000
            }).addTo(map);
        }

        function startHeadingTracking() {
            if (window.DeviceOrientationEvent) {
                // Check if we need permission (iOS 13+)
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                window.addEventListener('deviceorientation', handleHeading);
                            }
                        })
                        .catch(console.error);
                } else {
                    window.addEventListener('deviceorientation', handleHeading);
                }
            }
        }

        function handleHeading(event) {
            if (event.webkitCompassHeading) {
                // iOS
                AppState.userHeading = event.webkitCompassHeading;
            } else if (event.alpha) {
                // Android
                AppState.userHeading = 360 - event.alpha;
            }

            // Update marker heading
            if (userLocationMarker) {
                const arrow = userLocationMarker.getElement()?.querySelector('.location-arrow');
                if (arrow) {
                    arrow.style.setProperty('--heading', `${AppState.userHeading}deg`);
                }
            }
        }

        /*********************************
        * UTILITY DRAWING
        *********************************/
        function startDrawing() {
            AppState.isDrawing = true;
            AppState.drawingPoints = [];
            
            document.getElementById('drawingControls').classList.add('visible');
            showToast('Tap on the map to draw utility line');

            // Change cursor
            map.getContainer().style.cursor = 'crosshair';
        }

        function handleMapClick(e) {
            if (!AppState.isDrawing) return;

            const point = [e.latlng.lat, e.latlng.lng];
            AppState.drawingPoints.push(point);

            // Update temporary line
            updateTempLine();

            // Check for connections if more than one point
            if (AppState.drawingPoints.length > 1) {
                checkForConnections(e.latlng);
            }
        }

        function updateTempLine() {
            // Remove existing temp line
            if (AppState.tempLine) {
                map.removeLayer(AppState.tempLine);
            }

            if (AppState.drawingPoints.length < 2) return;

            // Create polyline
            AppState.tempLine = L.polyline(AppState.drawingPoints, {
                color: APP_CONFIG.utilityColors[AppState.currentUtility],
                weight: AppState.currentLineType === 'main' ? 6 : 4,
                opacity: 0.7,
                dashArray: AppState.currentLineType === 'service' ? '8, 8' : null,
                className: `utility-line ${AppState.currentUtility} ${AppState.currentLineType}`
            }).addTo(map);
        }

        function checkForConnections(latlng) {
            const threshold = 50; // feet
            let nearestUtility = null;
            let nearestDistance = Infinity;

            // Check all utilities
            AppState.utilities.forEach(utility => {
                if (utility.type !== AppState.currentUtility) return;
                
                // Only connect service to main or same types
                if (AppState.currentLineType === 'service' && utility.lineType !== 'main') return;
                if (AppState.currentLineType === 'main' && utility.lineType === 'service') return;

                // Check distance to utility line
                const distance = getDistanceToLine(latlng, utility.points);
                if (distance < threshold && distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestUtility = utility;
                }
            });

            if (nearestUtility) {
                showConnectionIndicator(latlng, nearestUtility);
            } else {
                hideConnectionIndicator();
            }
        }

        function showConnectionIndicator(latlng, targetUtility) {
            const indicator = document.getElementById('connectionIndicator');
            const point = map.latLngToContainerPoint(latlng);
            
            indicator.style.left = `${point.x}px`;
            indicator.style.top = `${point.y - 30}px`;
            indicator.classList.add('visible');
            
            indicator.onclick = () => {
                connectToUtility(targetUtility);
                hideConnectionIndicator();
            };
        }

        function hideConnectionIndicator() {
            document.getElementById('connectionIndicator').classList.remove('visible');
        }

        function connectToUtility(targetUtility) {
            // Snap last point to nearest point on target line
            const lastPoint = AppState.drawingPoints[AppState.drawingPoints.length - 1];
            const snapPoint = getNearestPointOnLine(lastPoint, targetUtility.points);
            AppState.drawingPoints[AppState.drawingPoints.length - 1] = snapPoint;
            
            updateTempLine();
            showToast('Connected to ' + targetUtility.type + ' ' + targetUtility.lineType);
        }

        function finishDrawing() {
            if (AppState.drawingPoints.length < 2) {
                showToast('Need at least 2 points to create a utility');
                return;
            }

            // Show utility info modal
            document.getElementById('utilityModal').classList.add('visible');
            
            // Reset form
            document.getElementById('utilityForm').reset();
        }

        function cancelDrawing() {
            AppState.isDrawing = false;
            AppState.drawingPoints = [];
            
            if (AppState.tempLine) {
                map.removeLayer(AppState.tempLine);
                AppState.tempLine = null;
            }
            
            document.getElementById('drawingControls').classList.remove('visible');
            map.getContainer().style.cursor = '';
            hideConnectionIndicator();
        }

        function saveUtility(data) {
            const utility = {
                id: Date.now(),
                type: AppState.currentUtility,
                lineType: AppState.currentLineType,
                points: AppState.drawingPoints,
                ...data,
                timestamp: new Date().toISOString()
            };

            // Add to state
            AppState.utilities.push(utility);

            // Create line on map
            const line = L.polyline(utility.points, {
                color: APP_CONFIG.utilityColors[utility.type],
                weight: utility.lineType === 'main' ? 6 : 4,
                opacity: 1,
                dashArray: utility.lineType === 'service' ? '8, 8' : null,
                className: `utility-line ${utility.type} ${utility.lineType}`
            });

            line.utilityId = utility.id;
            line.on('click', (e) => handleUtilityClick(e, utility));
            
            // Add to appropriate layer
            line.addTo(utilityLayers[utility.type]);
            utility.lineElement = line;

            // Save to localStorage
            saveToLocalStorage();

            // Clean up
            cancelDrawing();
            showToast('Utility saved successfully');
        }

        /*********************************
        * UTILITY INTERACTION
        *********************************/
        function handleUtilityClick(e, utility) {
            e.originalEvent.stopPropagation();
            
            // Check for long press
            let pressTimer;
            let longPress = false;

            const startPress = () => {
                pressTimer = setTimeout(() => {
                    longPress = true;
                    showUtilityInfo(utility);
                }, 500);
            };

            const endPress = () => {
                clearTimeout(pressTimer);
                if (!longPress) {
                    // Short press - highlight
                    highlightUtility(utility);
                }
                longPress = false;
            };

            // Handle both mouse and touch
            if (e.originalEvent.type === 'click') {
                showUtilityInfo(utility);
            }
        }

        function showUtilityInfo(utility) {
            AppState.selectedUtility = utility;
            
            const popup = document.getElementById('utilityInfoPopup');
            const icon = document.getElementById('popupIcon');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');

            // Update icon and title
            icon.className = `fas ${APP_CONFIG.utilityIcons[utility.type]}`;
            icon.style.color = APP_CONFIG.utilityColors[utility.type];
            title.textContent = `${utility.type.charAt(0).toUpperCase() + utility.type.slice(1)} ${utility.lineType.charAt(0).toUpperCase() + utility.lineType.slice(1)} Line`;

            // Build content
            content.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Depth</span>
                    <span class="info-value">${utility.depth || 'N/A'} ft</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Size</span>
                    <span class="info-value">${utility.size || 'N/A'} in</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Material</span>
                    <span class="info-value">${utility.material || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Condition</span>
                    <span class="info-value">${utility.condition || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Distance from Curb</span>
                    <span class="info-value">${utility.distance || 'N/A'} ft</span>
                </div>
                ${utility.image ? `<img src="${utility.image}" style="width: 100%; margin-top: var(--spacing-md); border-radius: var(--radius-md);">` : ''}
            `;

            popup.classList.add('visible');
        }

        function highlightUtility(utility) {
            // Remove existing highlights
            document.querySelectorAll('.utility-line.highlight').forEach(el => {
                el.classList.remove('highlight');
            });

            // Add highlight
            if (utility.lineElement) {
                utility.lineElement.getElement()?.classList.add('highlight');
            }
        }

        /*********************************
        * REFINE LOCATION
        *********************************/
        function startRefineLocation() {
            if (!AppState.selectedUtility) return;

            AppState.isRefining = true;
            AppState.refinePoints = [];

            const utility = AppState.selectedUtility;
            
            // Hide info popup
            document.getElementById('utilityInfoPopup').classList.remove('visible');
            
            // Show refine controls
            document.getElementById('refineControls').classList.add('visible');

            // Create draggable points
            utility.points.forEach((point, index) => {
                const marker = L.marker(point, {
                    icon: L.divIcon({
                        className: 'refine-point',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    }),
                    draggable: true,
                    zIndexOffset: 2000
                });

                marker.on('drag', (e) => {
                    utility.points[index] = [e.latlng.lat, e.latlng.lng];
                    updateUtilityLine(utility);
                });

                marker.addTo(map);
                AppState.refinePoints.push(marker);
            });

            showToast('Drag points to refine location');
        }

        function updateUtilityLine(utility) {
            if (utility.lineElement) {
                utility.lineElement.setLatLngs(utility.points);
            }
        }

        function saveRefinedLocation() {
            // Remove refine markers
            AppState.refinePoints.forEach(marker => map.removeLayer(marker));
            AppState.refinePoints = [];
            
            AppState.isRefining = false;
            document.getElementById('refineControls').classList.remove('visible');
            
            // Save to localStorage
            saveToLocalStorage();
            
            showToast('Location updated successfully');
        }

        function cancelRefineLocation() {
            // Restore original points
            const utility = AppState.selectedUtility;
            if (utility && utility.originalPoints) {
                utility.points = [...utility.originalPoints];
                updateUtilityLine(utility);
            }

            // Remove refine markers
            AppState.refinePoints.forEach(marker => map.removeLayer(marker));
            AppState.refinePoints = [];
            
            AppState.isRefining = false;
            document.getElementById('refineControls').classList.remove('visible');
        }

        /*********************************
        * EXCAVATION MODE
        *********************************/
        function startExcavationHold() {
            const button = document.getElementById('excavationBtn');
            const progress = button.querySelector('.excavation-progress');
            
            AppState.excavationProgress = 0;
            progress.classList.add('active');
            
            const startTime = Date.now();
            
            AppState.excavationHoldTimeout = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const percent = (elapsed / APP_CONFIG.excavationHoldTime) * 100;
                
                if (percent >= 100) {
                    clearInterval(AppState.excavationHoldTimeout);
                    enterExcavationMode();
                } else {
                    AppState.excavationProgress = percent;
                    progress.style.setProperty('--progress', `${percent * 3.6}deg`);
                }
            }, 10);
        }

        function cancelExcavationHold() {
            if (AppState.excavationHoldTimeout) {
                clearInterval(AppState.excavationHoldTimeout);
                AppState.excavationHoldTimeout = null;
            }
            
            const progress = document.querySelector('.excavation-progress');
            progress.classList.remove('active');
            AppState.excavationProgress = 0;
        }

        function enterExcavationMode() {
            AppState.isExcavationMode = true;
            
            // Update UI
            document.getElementById('excavationBtn').classList.add('visible');
            document.getElementById('excavationIndicator').classList.add('visible');
            document.getElementById('drawBtn').style.display = 'none';
            
            // Zoom to user location
            if (AppState.userLocation) {
                map.setView(AppState.userLocation, 20);
                map.setMinZoom(18);
            }
            
            // Start proximity checking
            startProximityChecking();
            
            showToast('Excavation Mode Active - Stay Alert!');
        }

        function exitExcavationMode() {
            AppState.isExcavationMode = false;
            
            // Update UI
            document.getElementById('excavationBtn').classList.remove('visible');
            document.getElementById('excavationIndicator').classList.remove('visible');
            document.getElementById('drawBtn').style.display = '';
            
            // Reset map zoom
            map.setMinZoom(10);
            
            // Stop proximity checking
            stopProximityChecking();
            
            // Clear all alerts
            document.getElementById('proximityAlerts').innerHTML = '';
            
            showToast('Excavation Mode Deactivated');
        }

        function startProximityChecking() {
            // Check immediately
            checkProximityAlerts();
            
            // Then check every second
            AppState.proximityCheckInterval = setInterval(checkProximityAlerts, 1000);
        }

        function stopProximityChecking() {
            if (AppState.proximityCheckInterval) {
                clearInterval(AppState.proximityCheckInterval);
                AppState.proximityCheckInterval = null;
            }
        }

        function checkProximityAlerts() {
            if (!AppState.userLocation) return;
            
            const alerts = document.getElementById('proximityAlerts');
            const activeAlerts = new Set();
            
            AppState.utilities.forEach(utility => {
                // Check visibility
                if (!AppState.visibilitySettings[utility.type] || 
                    !AppState.visibilitySettings[utility.lineType]) return;
                
                // Check if dismissed
                const dismissedUntil = AppState.dismissedAlerts.get(utility.id);
                if (dismissedUntil && Date.now() < dismissedUntil) return;
                
                // Calculate distance
                const distance = getDistanceToLine(AppState.userLocation, utility.points);
                
                if (distance <= APP_CONFIG.proximityRadius) {
                    activeAlerts.add(utility.id);
                    
                    // Create or update alert
                    let alertEl = document.getElementById(`alert-${utility.id}`);
                    if (!alertEl) {
                        alertEl = createProximityAlert(utility, distance);
                        alerts.appendChild(alertEl);
                        setTimeout(() => alertEl.classList.add('visible'), 10);
                    } else {
                        updateProximityAlert(alertEl, distance);
                    }
                }
            });
            
            // Remove alerts that are no longer active
            Array.from(alerts.children).forEach(alertEl => {
                const utilityId = parseInt(alertEl.id.replace('alert-', ''));
                if (!activeAlerts.has(utilityId)) {
                    const utility = AppState.utilities.find(u => u.id === utilityId);
                    if (utility) {
                        handleAlertDismissal(utility, alertEl);
                    }
                }
            });
        }

        function createProximityAlert(utility, distance) {
            const alertEl = document.createElement('div');
            alertEl.id = `alert-${utility.id}`;
            alertEl.className = 'proximity-alert';
            alertEl.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">
                        <i class="fas ${APP_CONFIG.utilityIcons[utility.type]}" style="color: ${APP_CONFIG.utilityColors[utility.type]}"></i>
                        ${utility.type.charAt(0).toUpperCase() + utility.type.slice(1)} ${utility.lineType} Line
                    </div>
                    <button class="alert-close" onclick="dismissAlert(${utility.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="alert-content">
                    <div class="alert-info">
                        <i class="fas fa-arrows-alt-v"></i> ${utility.depth || 'Unknown'} ft deep
                    </div>
                    <div class="alert-info">
                        <i class="fas fa-ruler"></i> ${utility.size || 'Unknown'} in
                    </div>
                    <div class="alert-info">
                        <i class="fas fa-cube"></i> ${utility.material || 'Unknown'}
                    </div>
                </div>
                <div class="alert-distance">
                    <i class="fas fa-location-arrow"></i> ${Math.round(distance)} ft away
                </div>
            `;
            
            return alertEl;
        }

        function updateProximityAlert(alertEl, distance) {
            const distanceEl = alertEl.querySelector('.alert-distance');
            distanceEl.innerHTML = `<i class="fas fa-location-arrow"></i> ${Math.round(distance)} ft away`;
        }

        function handleAlertDismissal(utility, alertEl) {
            // Check if it's been outside radius for 45 seconds
            const lastSeen = alertEl.dataset.lastSeen;
            const now = Date.now();
            
            if (!lastSeen) {
                alertEl.dataset.lastSeen = now;
            } else if (now - parseInt(lastSeen) >= APP_CONFIG.alertDismissTime) {
                alertEl.classList.remove('visible');
                setTimeout(() => alertEl.remove(), 300);
            }
        }

        function dismissAlert(utilityId) {
            // Add to dismissed alerts with cooldown
            AppState.dismissedAlerts.set(utilityId, Date.now() + APP_CONFIG.alertCooldown);
            
            // Remove alert element
            const alertEl = document.getElementById(`alert-${utilityId}`);
            if (alertEl) {
                alertEl.classList.remove('visible');
                setTimeout(() => alertEl.remove(), 300);
            }
            
            showToast('Alert dismissed for 3 minutes');
        }

        /*********************************
        * VISIBILITY CONTROLS
        *********************************/
        function updateVisibility() {
            // Update utility layers
            Object.keys(utilityLayers).forEach(type => {
                if (AppState.visibilitySettings[type]) {
                    map.addLayer(utilityLayers[type]);
                } else {
                    map.removeLayer(utilityLayers[type]);
                }
            });
            
            // Update individual utilities based on line type
            AppState.utilities.forEach(utility => {
                if (utility.lineElement) {
                    const visible = AppState.visibilitySettings[utility.type] && 
                                  AppState.visibilitySettings[utility.lineType];
                    utility.lineElement.setStyle({ opacity: visible ? 1 : 0 });
                }
            });
        }

        /*********************************
        * UTILITY FUNCTIONS
        *********************************/
        function getDistanceToLine(point, linePoints) {
            let minDistance = Infinity;
            
            for (let i = 0; i < linePoints.length - 1; i++) {
                const distance = distanceToSegment(point, linePoints[i], linePoints[i + 1]);
                minDistance = Math.min(minDistance, distance);
            }
            
            return minDistance * 3.28084; // Convert meters to feet
        }

        function distanceToSegment(point, p1, p2) {
            const x = point[1];
            const y = point[0];
            const x1 = p1[1];
            const y1 = p1[0];
            const x2 = p2[1];
            const y2 = p2[0];
            
            const A = x - x1;
            const B = y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = x - xx;
            const dy = y - yy;
            
            return Math.sqrt(dx * dx + dy * dy) * 111320; // Rough conversion to meters
        }

        function getNearestPointOnLine(point, linePoints) {
            let nearestPoint = null;
            let minDistance = Infinity;
            
            for (let i = 0; i < linePoints.length - 1; i++) {
                const projected = projectPointOnSegment(point, linePoints[i], linePoints[i + 1]);
                const distance = getDistance(point, projected);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPoint = projected;
                }
            }
            
            return nearestPoint;
        }

        function projectPointOnSegment(point, p1, p2) {
            const x = point[1];
            const y = point[0];
            const x1 = p1[1];
            const y1 = p1[0];
            const x2 = p2[1];
            const y2 = p2[0];
            
            const A = x - x1;
            const B = y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            return [yy, xx];
        }

        function getDistance(p1, p2) {
            const dx = p1[1] - p2[1];
            const dy = p1[0] - p2[0];
            return Math.sqrt(dx * dx + dy * dy);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        function saveToLocalStorage() {
            const data = {
                utilities: AppState.utilities.map(u => ({
                    ...u,
                    lineElement: undefined // Don't save Leaflet objects
                })),
                settings: {
                    theme: AppState.theme,
                    mapStyle: AppState.mapStyle,
                    visibilitySettings: AppState.visibilitySettings
                }
            };
            
            localStorage.setItem('cacUtiliTrack', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('cacUtiliTrack');
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                
                // Load utilities
                if (data.utilities) {
                    data.utilities.forEach(utilityData => {
                        const utility = { ...utilityData };
                        AppState.utilities.push(utility);
                        
                        // Recreate line on map
                        const line = L.polyline(utility.points, {
                            color: APP_CONFIG.utilityColors[utility.type],
                            weight: utility.lineType === 'main' ? 6 : 4,
                            opacity: 1,
                            dashArray: utility.lineType === 'service' ? '8, 8' : null,
                            className: `utility-line ${utility.type} ${utility.lineType}`
                        });
                        
                        line.utilityId = utility.id;
                        line.on('click', (e) => handleUtilityClick(e, utility));
                        line.addTo(utilityLayers[utility.type]);
                        utility.lineElement = line;
                    });
                }
                
                // Load settings
                if (data.settings) {
                    if (data.settings.theme) {
                        AppState.theme = data.settings.theme;
                        document.body.setAttribute('data-theme', AppState.theme);
                        updateThemeIcon();
                    }
                    
                    if (data.settings.mapStyle) {
                        updateMapStyle(data.settings.mapStyle);
                        updateMapStyleUI();
                    }
                    
                    if (data.settings.visibilitySettings) {
                        AppState.visibilitySettings = data.settings.visibilitySettings;
                        updateVisibilityUI();
                        updateVisibility();
                    }
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        /*********************************
        * EVENT LISTENERS
        *********************************/
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize app after splash screen
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('appContainer').classList.add('visible');
                    initializeMap();
                    loadFromLocalStorage();
                }, 500);
            }, 3000);

            // Utility selector
            document.querySelectorAll('.utility-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.utility-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    AppState.currentUtility = btn.dataset.utility;
                });
            });

            // Line type toggle
            document.querySelectorAll('.line-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.line-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    AppState.currentLineType = btn.dataset.type;
                });
            });

            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                map.zoomIn();
            });

            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                map.zoomOut();
            });

            document.getElementById('locationBtn').addEventListener('click', () => {
                if (AppState.userLocation) {
                    map.setView(AppState.userLocation, 18);
                    document.getElementById('locationBtn').classList.add('tracking');
                    showToast('Centered on your location');
                }
            });

            // Drawing
            document.getElementById('drawBtn').addEventListener('click', startDrawing);
            document.getElementById('finishDrawingBtn').addEventListener('click', finishDrawing);
            document.getElementById('cancelDrawingBtn').addEventListener('click', cancelDrawing);

            // Excavation mode
            const excavationBtn = document.getElementById('excavationBtn');
            let excavationPressStart = 0;

            excavationBtn.addEventListener('mousedown', () => {
                excavationPressStart = Date.now();
                startExcavationHold();
            });

            excavationBtn.addEventListener('mouseup', () => {
                if (Date.now() - excavationPressStart < APP_CONFIG.excavationHoldTime) {
                    cancelExcavationHold();
                }
            });

            excavationBtn.addEventListener('mouseleave', cancelExcavationHold);

            excavationBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                excavationPressStart = Date.now();
                startExcavationHold();
            });

            excavationBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (Date.now() - excavationPressStart < APP_CONFIG.excavationHoldTime) {
                    cancelExcavationHold();
                } else if (AppState.isExcavationMode) {
                    exitExcavationMode();
                }
            });

            excavationBtn.addEventListener('touchcancel', cancelExcavationHold);

            // Utility info popup
            document.getElementById('popupClose').addEventListener('click', () => {
                document.getElementById('utilityInfoPopup').classList.remove('visible');
            });

            document.getElementById('editUtilityBtn').addEventListener('click', () => {
                if (AppState.selectedUtility) {
                    // Pre-fill form
                    document.getElementById('utilityDepth').value = AppState.selectedUtility.depth || '';
                    document.getElementById('utilitySize').value = AppState.selectedUtility.size || '';
                    document.getElementById('utilityMaterial').value = AppState.selectedUtility.material || '';
                    document.getElementById('utilityCondition').value = AppState.selectedUtility.condition || '';
                    document.getElementById('utilityDistance').value = AppState.selectedUtility.distance || '';
                    
                    document.getElementById('utilityModal').classList.add('visible');
                    document.getElementById('utilityInfoPopup').classList.remove('visible');
                }
            });

            document.getElementById('refineLocationBtn').addEventListener('click', startRefineLocation);

            // Refine controls
            document.getElementById('saveRefineBtn').addEventListener('click', saveRefinedLocation);
            document.getElementById('cancelRefineBtn').addEventListener('click', cancelRefineLocation);

            // Utility form
            document.getElementById('utilityForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = {
                    depth: document.getElementById('utilityDepth').value,
                    size: document.getElementById('utilitySize').value,
                    material: document.getElementById('utilityMaterial').value,
                    condition: document.getElementById('utilityCondition').value,
                    distance: document.getElementById('utilityDistance').value
                };
                
                // Handle image
                const imageInput = document.getElementById('utilityImage');
                if (imageInput.files && imageInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        formData.image = e.target.result;
                        
                        if (AppState.selectedUtility) {
                            // Update existing
                            Object.assign(AppState.selectedUtility, formData);
                            saveToLocalStorage();
                            showToast('Utility updated successfully');
                        } else {
                            // Save new
                            saveUtility(formData);
                        }
                        
                        document.getElementById('utilityModal').classList.remove('visible');
                    };
                    reader.readAsDataURL(imageInput.files[0]);
                } else {
                    if (AppState.selectedUtility) {
                        // Update existing
                        Object.assign(AppState.selectedUtility, formData);
                        saveToLocalStorage();
                        showToast('Utility updated successfully');
                    } else {
                        // Save new
                        saveUtility(formData);
                    }
                    
                    document.getElementById('utilityModal').classList.remove('visible');
                }
            });

            document.getElementById('cancelUtilityBtn').addEventListener('click', () => {
                document.getElementById('utilityModal').classList.remove('visible');
                if (!AppState.selectedUtility) {
                    cancelDrawing();
                }
            });

            // Structure form
            document.getElementById('structureForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const selectedOption = document.querySelector('.structure-option.selected');
                if (!selectedOption) {
                    showToast('Please select a structure type');
                    return;
                }
                
                const formData = {
                    structureType: selectedOption.dataset.structureType,
                    notes: document.getElementById('structureNotes').value
                };
                
                // Handle image
                const imageInput = document.getElementById('structureImage');
                if (imageInput.files && imageInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        formData.image = e.target.result;
                        saveStructure(formData);
                        document.getElementById('structureModal').classList.remove('visible');
                    };
                    reader.readAsDataURL(imageInput.files[0]);
                } else {
                    saveStructure(formData);
                    document.getElementById('structureModal').classList.remove('visible');
                }
            });

            document.getElementById('cancelStructureBtn').addEventListener('click', () => {
                document.getElementById('structureModal').classList.remove('visible');
                cancelAddingStructure();
            });

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsMenu').classList.toggle('visible');
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', () => {
                AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', AppState.theme);
                updateThemeIcon();
                saveToLocalStorage();
            });

            // Visibility toggles
            document.querySelectorAll('.toggle-switch[data-utility]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const utility = toggle.dataset.utility;
                    AppState.visibilitySettings[utility] = !AppState.visibilitySettings[utility];
                    toggle.classList.toggle('active');
                    updateVisibility();
                    saveToLocalStorage();
                });
            });

            document.querySelectorAll('.toggle-switch[data-linetype]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const lineType = toggle.dataset.linetype;
                    AppState.visibilitySettings[lineType] = !AppState.visibilitySettings[lineType];
                    toggle.classList.toggle('active');
                    updateVisibility();
                    saveToLocalStorage();
                });
            });

            // Map style selector
            document.querySelectorAll('.map-style-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.map-style-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    updateMapStyle(option.dataset.style);
                    saveToLocalStorage();
                });
            });

            // Prevent default touch behaviors
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('#map')) return;
                e.preventDefault();
            }, { passive: false });

            // Handle orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            });

            // Close settings menu when clicking outside
            document.addEventListener('click', (e) => {
                const settingsMenu = document.getElementById('settingsMenu');
                const settingsBtn = document.getElementById('settingsBtn');
                
                if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                    settingsMenu.classList.remove('visible');
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (map) {
                    map.invalidateSize();
                }
            });
        });

        function updateThemeIcon() {
            const icon = document.querySelector('#themeToggle i');
            icon.className = AppState.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function updateMapStyleUI() {
            document.querySelectorAll('.map-style-option').forEach(option => {
                option.classList.toggle('active', option.dataset.style === AppState.mapStyle);
            });
        }

        function updateVisibilityUI() {
            document.querySelectorAll('.toggle-switch[data-utility]').forEach(toggle => {
                const utility = toggle.dataset.utility;
                toggle.classList.toggle('active', AppState.visibilitySettings[utility]);
            });
            
            document.querySelectorAll('.toggle-switch[data-linetype]').forEach(toggle => {
                const lineType = toggle.dataset.linetype;
                toggle.classList.toggle('active', AppState.visibilitySettings[lineType]);
            });
        }

        // Disable context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // Add ripple effect to buttons
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.className = 'fab-ripple';
                
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                this.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            });
        });

        // Prevent zooming on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Prevent pull-to-refresh
        document.body.addEventListener('touchmove', (e) => {
            if (e.touches[0].clientY > 0) {
                e.preventDefault();
            }
        }, { passive: false });

        // Handle app visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && AppState.isExcavationMode) {
                // Pause proximity checking when app is in background
                stopProximityChecking();
            } else if (!document.hidden && AppState.isExcavationMode) {
                // Resume proximity checking when app is active
                startProximityChecking();
            }
        });

        // Error boundary for critical functions
        window.addEventListener('error', (e) => {
            console.error('Global error:', e);
            showToast('An error occurred. Please refresh the app.');
        });

        // Service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                // Service worker registration failed, app will work without offline support
            });
        }
    </script>
</body>
</html>Input.files && imageInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        formData.image = e.target.result;
                        
                        if (AppState.selectedUtility) {
                            // Update existing
                            Object.assign(AppState.selectedUtility, formData);
                            saveToLocalStorage();
                            showToast('Utility updated successfully');
                        } else {
                            // Save new
                            saveUtility(formData);
                        }
                        
                        document.getElementById('utilityModal').classList.remove('visible');
                    };
                    reader.readAsDataURL(imageInput.files[0]);
                } else {
                    if (AppState.selectedUtility) {
                        // Update existing
                        Object.assign(AppState.selectedUtility, formData);
                        saveToLocalStorage();
                        showToast('Utility updated successfully');
                    } else {
                        // Save new
                        saveUtility(formData);
                    }
                    
                    document.getElementById('utilityModal').classList.remove('visible');
                }
            });

            document.getElementById('cancelUtilityBtn').addEventListener('click', () => {
                document.getElementById('utilityModal').classList.remove('visible');
                if (!AppState.selectedUtility) {
                    cancelDrawing();
                }
            });

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsMenu').classList.toggle('visible');
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', () => {
                AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', AppState.theme);
                updateThemeIcon();
                saveToLocalStorage();
            });

            // Visibility toggles
            document.querySelectorAll('.toggle-switch[data-utility]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const utility = toggle.dataset.utility;
                    AppState.visibilitySettings[utility] = !AppState.visibilitySettings[utility];
                    toggle.classList.toggle('active');
                    updateVisibility();
                    saveToLocalStorage();
                });
            });

            document.querySelectorAll('.toggle-switch[data-linetype]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const lineType = toggle.dataset.linetype;
                    AppState.visibilitySettings[lineType] = !AppState.visibilitySettings[lineType];
                    toggle.classList.toggle('active');
                    updateVisibility();
                    saveToLocalStorage();
                });
            });

            // Map style selector
            document.querySelectorAll('.map-style-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.map-style-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    updateMapStyle(option.dataset.style);
                    saveToLocalStorage();
                });
            });

            // Prevent default touch behaviors
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('#map')) return;
                e.preventDefault();
            }, { passive: false });

            // Handle orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            });
        });

        function updateThemeIcon() {
            const icon = document.querySelector('#themeToggle i');
            icon.className = AppState.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function updateMapStyleUI() {
            document.querySelectorAll('.map-style-option').forEach(option => {
                option.classList.toggle('active', option.dataset.style === AppState.mapStyle);
            });
        }

        function updateVisibilityUI() {
            document.querySelectorAll('.toggle-switch[data-utility]').forEach(toggle => {
                const utility = toggle.dataset.utility;
                toggle.classList.toggle('active', AppState.visibilitySettings[utility]);
            });
            
            document.querySelectorAll('.toggle-switch[data-linetype]').forEach(toggle => {
                const lineType = toggle.dataset.linetype;
                toggle.classList.toggle('active', AppState.visibilitySettings[lineType]);
            });
        }

        // Disable context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // Add ripple effect to buttons
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.className = 'fab-ripple';
                
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                this.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            });
        });
    </script>
</body>
</html>
